
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../custom_types/">
      
      
        <link rel="next" href="optics_group/">
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.5">
    
    
      
        <title>data_structures - Leopard-EM: Two-Dimensional Template Matching in Python</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.8608ea7d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#leopard_em.pydantic_models.data_structures" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Leopard-EM: Two-Dimensional Template Matching in Python" class="md-header__button md-logo" aria-label="Leopard-EM: Two-Dimensional Template Matching in Python" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Leopard-EM: Two-Dimensional Template Matching in Python
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              data_structures
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Leopard-EM: Two-Dimensional Template Matching in Python" class="md-nav__button md-logo" aria-label="Leopard-EM: Two-Dimensional Template Matching in Python" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Leopard-EM: Two-Dimensional Template Matching in Python
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../tutorials/batch_processing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Batch Processing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../examples/01_basic_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuring Pydantic models in Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../examples/02_extract_peak_info/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Extracting results from the template matching search
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../examples/03_compare_scoring_metrics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Comparing 2DTM scoring metrics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../examples/04_plotting_2dtm_results/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Visualizing 2DTM result
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../examples/05_structure_reprojection/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Structure projections on an Image
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Programs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Programs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programs/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programs/match_template/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Match Template details
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programs/refine_template/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Refine Template details
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programs/optimize_template/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimize Template details
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../programs/constrained_search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Constrained Search details
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../data_formats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Program Output Formats
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../contributing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    leopard_em
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1" id="__nav_7_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7_1">
            <span class="md-nav__icon md-icon"></span>
            leopard_em
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../analysis/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    analysis
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_1" id="__nav_7_1_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_1">
            <span class="md-nav__icon md-icon"></span>
            analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../analysis/gev_fit_metric/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    gev_fit_metric
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../analysis/match_template_peaks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    match_template_peaks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../analysis/pvalue_metric/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pvalue_metric
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../analysis/utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../analysis/zscore_metric/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    zscore_metric
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../backend/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    backend
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_2" id="__nav_7_1_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_2">
            <span class="md-nav__icon md-icon"></span>
            backend
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../backend/core_match_template/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    core_match_template
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../backend/core_refine_template/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    core_refine_template
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../backend/cross_correlation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cross_correlation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../backend/process_results/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    process_results
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../backend/utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_3" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    pydantic_models
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_3" id="__nav_7_1_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7_1_3">
            <span class="md-nav__icon md-icon"></span>
            pydantic_models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_3_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../config/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    config
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_3_1" id="__nav_7_1_3_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_1_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_3_1">
            <span class="md-nav__icon md-icon"></span>
            config
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/computational_config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    computational_config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/correlation_filters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    correlation_filters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/defocus_search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    defocus_search
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/orientation_search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    orientation_search
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/pixel_size_search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pixel_size_search
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../custom_types/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    custom_types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_3_3" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="./" class="md-nav__link md-nav__link--active">
              
  
  <span class="md-ellipsis">
    data_structures
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link md-nav__link--active" for="__nav_7_1_3_3" id="__nav_7_1_3_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_1_3_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7_1_3_3">
            <span class="md-nav__icon md-icon"></span>
            data_structures
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="optics_group/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    optics_group
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="particle_stack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    particle_stack
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../formats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    formats
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_3_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../managers/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    managers
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_3_5" id="__nav_7_1_3_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_1_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_3_5">
            <span class="md-nav__icon md-icon"></span>
            managers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../managers/constrained_search_manager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    constrained_search_manager
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../managers/match_template_manager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    match_template_manager
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../managers/optimize_template_manager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    optimize_template_manager
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../managers/refine_template_manager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    refine_template_manager
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_3_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../results/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    results
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_3_6" id="__nav_7_1_3_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_1_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_3_6">
            <span class="md-nav__icon md-icon"></span>
            results
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../results/match_template_result/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    match_template_result
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../utils/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    utils
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_4" id="__nav_7_1_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_4">
            <span class="md-nav__icon md-icon"></span>
            utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/cross_correlation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cross_correlation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/data_io/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    data_io
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/fourier_slice/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    fourier_slice
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#leopard_em.pydantic_models.data_structures" class="md-nav__link">
    <span class="md-ellipsis">
      data_structures
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#leopard_em.pydantic_models.data_structures.OpticsGroup" class="md-nav__link">
    <span class="md-ellipsis">
      OpticsGroup
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#leopard_em.pydantic_models.data_structures.ParticleStack" class="md-nav__link">
    <span class="md-ellipsis">
      ParticleStack
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ParticleStack">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#leopard_em.pydantic_models.data_structures.ParticleStack.df_columns" class="md-nav__link">
    <span class="md-ellipsis">
      df_columns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leopard_em.pydantic_models.data_structures.ParticleStack.num_particles" class="md-nav__link">
    <span class="md-ellipsis">
      num_particles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leopard_em.pydantic_models.data_structures.ParticleStack.__getitem__" class="md-nav__link">
    <span class="md-ellipsis">
      __getitem__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leopard_em.pydantic_models.data_structures.ParticleStack.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leopard_em.pydantic_models.data_structures.ParticleStack.construct_cropped_statistic_stack" class="md-nav__link">
    <span class="md-ellipsis">
      construct_cropped_statistic_stack
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leopard_em.pydantic_models.data_structures.ParticleStack.construct_filter_stack" class="md-nav__link">
    <span class="md-ellipsis">
      construct_filter_stack
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leopard_em.pydantic_models.data_structures.ParticleStack.construct_image_stack" class="md-nav__link">
    <span class="md-ellipsis">
      construct_image_stack
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leopard_em.pydantic_models.data_structures.ParticleStack.get_absolute_defocus" class="md-nav__link">
    <span class="md-ellipsis">
      get_absolute_defocus
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leopard_em.pydantic_models.data_structures.ParticleStack.get_dataframe_copy" class="md-nav__link">
    <span class="md-ellipsis">
      get_dataframe_copy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leopard_em.pydantic_models.data_structures.ParticleStack.get_euler_angles" class="md-nav__link">
    <span class="md-ellipsis">
      get_euler_angles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leopard_em.pydantic_models.data_structures.ParticleStack.get_pixel_size" class="md-nav__link">
    <span class="md-ellipsis">
      get_pixel_size
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leopard_em.pydantic_models.data_structures.ParticleStack.get_relative_defocus" class="md-nav__link">
    <span class="md-ellipsis">
      get_relative_defocus
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leopard_em.pydantic_models.data_structures.ParticleStack.load_df" class="md-nav__link">
    <span class="md-ellipsis">
      load_df
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leopard_em.pydantic_models.data_structures.ParticleStack.set_column" class="md-nav__link">
    <span class="md-ellipsis">
      set_column
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>data_structures</h1>

<div class="doc doc-object doc-module">



<a id="leopard_em.pydantic_models.data_structures"></a>
    <div class="doc doc-contents first">

        <p>Pydantic models for reused data structures across Leopard-EM programs.</p>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="leopard_em.pydantic_models.data_structures.OpticsGroup" class="doc doc-heading">
            <code>OpticsGroup</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseModel2DTM (leopard_em.pydantic_models.custom_types.BaseModel2DTM)" href="../custom_types/#leopard_em.pydantic_models.custom_types.BaseModel2DTM">BaseModel2DTM</a></code></p>


        <p>Stores optics group parameters for the imaging system on a microscope.</p>
<p>Currently utilizes the minimal set of parameters for calculating a
contrast transfer function (CTF) for a given optics group. Other parameters
for future use are included but currently unused.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="leopard_em.pydantic_models.data_structures.OpticsGroup.label">label</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique string (among other optics groups) for the optics group.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="leopard_em.pydantic_models.data_structures.OpticsGroup.pixel_size">pixel_size</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pixel size in Angstrom.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="leopard_em.pydantic_models.data_structures.OpticsGroup.voltage">voltage</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Voltage in kV.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="leopard_em.pydantic_models.data_structures.OpticsGroup.spherical_aberration">spherical_aberration</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spherical aberration in mm. Default is 2.7.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="leopard_em.pydantic_models.data_structures.OpticsGroup.amplitude_contrast_ratio">amplitude_contrast_ratio</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Amplitude contrast ratio as a unitless percentage in [0, 1]. Default
is 0.07.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="leopard_em.pydantic_models.data_structures.OpticsGroup.phase_shift">phase_shift</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional phase shift of the contrast transfer function in degrees.
Default is 0.0 degrees.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="leopard_em.pydantic_models.data_structures.OpticsGroup.defocus_u">defocus_u</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Defocus (underfocus) along the major axis in Angstrom.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="leopard_em.pydantic_models.data_structures.OpticsGroup.defocus_v">defocus_v</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Defocus (underfocus) along the minor axis in Angstrom.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="leopard_em.pydantic_models.data_structures.OpticsGroup.astigmatism_angle">astigmatism_angle</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Angle of defocus astigmatism relative to the X-axis in degrees.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="leopard_em.pydantic_models.data_structures.OpticsGroup.ctf_B_factor">ctf_B_factor</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>B-factor to apply in the contrast transfer function in A^2. Default
is 0.0.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="unused-attributes:" open>
  <summary>Unused Attributes:</summary>
  <p>chromatic_aberration : float
    Chromatic aberration in mm. Default is ???.
mtf_reference : str | PathLike
    Path to MTF reference file.
mtf_values : list[float]
    list of modulation transfer functions values on evenly spaced
    resolution grid [0.0, ..., 0.5].
beam_tilt_x : float
    Beam tilt X in mrad.
beam_tilt_y : float
    Beam tilt Y in mrad.
odd_zernike : list[float]
    list of odd Zernike moments.
even_zernike : list[float]
    list of even Zernike moments.
zernike_moments : list[float]
    list of Zernike moments.</p>
</details>

<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><span title="leopard_em.pydantic_models.data_structures.OpticsGroup.model_dump">model_dump</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Returns a dictionary of the model parameters.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/leopard_em/pydantic_models/data_structures/optics_group.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">OpticsGroup</span><span class="p">(</span><span class="n">BaseModel2DTM</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stores optics group parameters for the imaging system on a microscope.</span>

<span class="sd">    Currently utilizes the minimal set of parameters for calculating a</span>
<span class="sd">    contrast transfer function (CTF) for a given optics group. Other parameters</span>
<span class="sd">    for future use are included but currently unused.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    label : str</span>
<span class="sd">        Unique string (among other optics groups) for the optics group.</span>
<span class="sd">    pixel_size : float</span>
<span class="sd">        Pixel size in Angstrom.</span>
<span class="sd">    voltage : float</span>
<span class="sd">        Voltage in kV.</span>
<span class="sd">    spherical_aberration : float</span>
<span class="sd">        Spherical aberration in mm. Default is 2.7.</span>
<span class="sd">    amplitude_contrast_ratio : float</span>
<span class="sd">        Amplitude contrast ratio as a unitless percentage in [0, 1]. Default</span>
<span class="sd">        is 0.07.</span>
<span class="sd">    phase_shift : float</span>
<span class="sd">        Additional phase shift of the contrast transfer function in degrees.</span>
<span class="sd">        Default is 0.0 degrees.</span>
<span class="sd">    defocus_u : float</span>
<span class="sd">        Defocus (underfocus) along the major axis in Angstrom.</span>
<span class="sd">    defocus_v : float</span>
<span class="sd">        Defocus (underfocus) along the minor axis in Angstrom.</span>
<span class="sd">    astigmatism_angle : float</span>
<span class="sd">        Angle of defocus astigmatism relative to the X-axis in degrees.</span>
<span class="sd">    ctf_B_factor : float</span>
<span class="sd">        B-factor to apply in the contrast transfer function in A^2. Default</span>
<span class="sd">        is 0.0.</span>

<span class="sd">    Unused Attributes:</span>
<span class="sd">    ------------------</span>
<span class="sd">    chromatic_aberration : float</span>
<span class="sd">        Chromatic aberration in mm. Default is ???.</span>
<span class="sd">    mtf_reference : str | PathLike</span>
<span class="sd">        Path to MTF reference file.</span>
<span class="sd">    mtf_values : list[float]</span>
<span class="sd">        list of modulation transfer functions values on evenly spaced</span>
<span class="sd">        resolution grid [0.0, ..., 0.5].</span>
<span class="sd">    beam_tilt_x : float</span>
<span class="sd">        Beam tilt X in mrad.</span>
<span class="sd">    beam_tilt_y : float</span>
<span class="sd">        Beam tilt Y in mrad.</span>
<span class="sd">    odd_zernike : list[float]</span>
<span class="sd">        list of odd Zernike moments.</span>
<span class="sd">    even_zernike : list[float]</span>
<span class="sd">        list of even Zernike moments.</span>
<span class="sd">    zernike_moments : list[float]</span>
<span class="sd">        list of Zernike moments.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    model_dump()</span>
<span class="sd">        Returns a dictionary of the model parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Currently implemented parameters</span>
    <span class="n">label</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">pixel_size</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)]</span>
    <span class="n">voltage</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)]</span>
    <span class="n">spherical_aberration</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">2.7</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">2.7</span>
    <span class="n">amplitude_contrast_ratio</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.07</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">0.07</span>
    <span class="p">)</span>
    <span class="n">phase_shift</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">defocus_u</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">defocus_v</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">astigmatism_angle</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">ctf_B_factor</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">chromatic_aberration</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)]]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">mtf_reference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">PathLike</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mtf_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">beam_tilt_x</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">beam_tilt_y</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">odd_zernike</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">even_zernike</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">zernike_moments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="leopard_em.pydantic_models.data_structures.ParticleStack" class="doc doc-heading">
            <code>ParticleStack</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseModel2DTM (leopard_em.pydantic_models.custom_types.BaseModel2DTM)" href="../custom_types/#leopard_em.pydantic_models.custom_types.BaseModel2DTM">BaseModel2DTM</a></code></p>


        <p>Pydantic model for dealing with particle stack data.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="leopard_em.pydantic_models.data_structures.ParticleStack.df_path">df_path</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the DataFrame containing the particle data. The DataFrame must have
the following columns (see the documentation for further information):</p>
<ul>
<li>mip</li>
<li>scaled_mip</li>
<li>correlation_mean</li>
<li>correlation_variance</li>
<li>total_correlations</li>
<li>pos_x</li>
<li>pos_y</li>
<li>pos_x_img</li>
<li>pos_y_img</li>
<li>pos_x_img_angstrom</li>
<li>pos_y_img_angstrom</li>
<li>psi</li>
<li>theta</li>
<li>phi</li>
<li>relative_defocus</li>
<li>refined_relative_defocus</li>
<li>defocus_u</li>
<li>defocus_v</li>
<li>astigmatism_angle</li>
<li>pixel_size</li>
<li>refined_pixel_size</li>
<li>voltage</li>
<li>spherical_aberration</li>
<li>amplitude_contrast_ratio</li>
<li>phase_shift</li>
<li>ctf_B_factor</li>
<li>micrograph_path</li>
<li>template_path</li>
<li>mip_path</li>
<li>scaled_mip_path</li>
<li>psi_path</li>
<li>theta_path</li>
<li>phi_path</li>
<li>defocus_path</li>
<li>correlation_average_path</li>
<li>correlation_variance_path</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="leopard_em.pydantic_models.data_structures.ParticleStack.extracted_box_size">extracted_box_size</span></code></td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The size of the extracted particle boxes in pixels in units of pixels.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="leopard_em.pydantic_models.data_structures.ParticleStack.original_template_size">original_template_size</span></code></td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The original size of the template used during the matching process. Should be
smaller than the extracted box size.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="leopard_em.pydantic_models.data_structures.ParticleStack.image_stack">image_stack</span></code></td>
            <td>
                  <code><span title="leopard_em.pydantic_models.custom_types.ExcludedTensor">ExcludedTensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The stack of images extracted from the micrographs. Is effectively a pytorch
Tensor with shape (N, H, W) where N is the number of particles and (H, W) is
the extracted box size.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src/leopard_em/pydantic_models/data_structures/particle_stack.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ParticleStack</span><span class="p">(</span><span class="n">BaseModel2DTM</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pydantic model for dealing with particle stack data.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    df_path : str</span>
<span class="sd">        Path to the DataFrame containing the particle data. The DataFrame must have</span>
<span class="sd">        the following columns (see the documentation for further information):</span>

<span class="sd">          - mip</span>
<span class="sd">          - scaled_mip</span>
<span class="sd">          - correlation_mean</span>
<span class="sd">          - correlation_variance</span>
<span class="sd">          - total_correlations</span>
<span class="sd">          - pos_x</span>
<span class="sd">          - pos_y</span>
<span class="sd">          - pos_x_img</span>
<span class="sd">          - pos_y_img</span>
<span class="sd">          - pos_x_img_angstrom</span>
<span class="sd">          - pos_y_img_angstrom</span>
<span class="sd">          - psi</span>
<span class="sd">          - theta</span>
<span class="sd">          - phi</span>
<span class="sd">          - relative_defocus</span>
<span class="sd">          - refined_relative_defocus</span>
<span class="sd">          - defocus_u</span>
<span class="sd">          - defocus_v</span>
<span class="sd">          - astigmatism_angle</span>
<span class="sd">          - pixel_size</span>
<span class="sd">          - refined_pixel_size</span>
<span class="sd">          - voltage</span>
<span class="sd">          - spherical_aberration</span>
<span class="sd">          - amplitude_contrast_ratio</span>
<span class="sd">          - phase_shift</span>
<span class="sd">          - ctf_B_factor</span>
<span class="sd">          - micrograph_path</span>
<span class="sd">          - template_path</span>
<span class="sd">          - mip_path</span>
<span class="sd">          - scaled_mip_path</span>
<span class="sd">          - psi_path</span>
<span class="sd">          - theta_path</span>
<span class="sd">          - phi_path</span>
<span class="sd">          - defocus_path</span>
<span class="sd">          - correlation_average_path</span>
<span class="sd">          - correlation_variance_path</span>

<span class="sd">    extracted_box_size : tuple[int, int]</span>
<span class="sd">        The size of the extracted particle boxes in pixels in units of pixels.</span>
<span class="sd">    original_template_size : tuple[int, int]</span>
<span class="sd">        The original size of the template used during the matching process. Should be</span>
<span class="sd">        smaller than the extracted box size.</span>
<span class="sd">    image_stack : ExcludedTensor</span>
<span class="sd">        The stack of images extracted from the micrographs. Is effectively a pytorch</span>
<span class="sd">        Tensor with shape (N, H, W) where N is the number of particles and (H, W) is</span>
<span class="sd">        the extracted box size.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_config</span><span class="p">:</span> <span class="n">ClassVar</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">arbitrary_types_allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Serialized fields</span>
    <span class="n">df_path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">extracted_box_size</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="n">original_template_size</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>

    <span class="c1"># Imported tabular data (not serialized)</span>
    <span class="n">_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>

    <span class="c1"># Cropped out view of the particles from images</span>
    <span class="n">image_stack</span><span class="p">:</span> <span class="n">ExcludedTensor</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_df_load</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the ParticleStack object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        skip_df_load : bool, optional</span>
<span class="sd">            Whether to skip loading the DataFrame, by default False and the dataframe</span>
<span class="sd">            is loaded automatically.</span>
<span class="sd">        data : dict[str, Any]</span>
<span class="sd">            The data to initialize the object with.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_df_load</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_df</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the DataFrame from the specified path.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the DataFrame is missing required columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_path</span><span class="p">)</span>

        <span class="c1"># Validate the DataFrame columns</span>
        <span class="n">missing_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">MATCH_TEMPLATE_DF_COLUMN_ORDER</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tmp_df</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Missing the following columns in DataFrame: </span><span class="si">{</span><span class="n">missing_columns</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">tmp_df</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_position_reference_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the position reference columns based on the DataFrame.&quot;&quot;&quot;</span>
        <span class="n">y_col</span> <span class="o">=</span> <span class="s2">&quot;refined_pos_y&quot;</span> <span class="k">if</span> <span class="s2">&quot;refined_pos_y&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="s2">&quot;pos_y&quot;</span>
        <span class="n">x_col</span> <span class="o">=</span> <span class="s2">&quot;refined_pos_x&quot;</span> <span class="k">if</span> <span class="s2">&quot;refined_pos_x&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="s2">&quot;pos_x&quot;</span>
        <span class="k">return</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">x_col</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">construct_image_stack</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pos_reference</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="s2">&quot;top-left&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;top-left&quot;</span><span class="p">,</span>
        <span class="n">handle_bounds</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;pad&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pad&quot;</span><span class="p">,</span>
        <span class="n">padding_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="s2">&quot;reflect&quot;</span><span class="p">,</span> <span class="s2">&quot;replicate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;constant&quot;</span><span class="p">,</span>
        <span class="n">padding_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct stack of images from the DataFrame (updates image_stack in-place).</span>

<span class="sd">        This method preferentially selects refined position columns by default</span>
<span class="sd">        (refined_pos_x, refined_pos_y) if they are present in the DataFrame, falling</span>
<span class="sd">        back to unrefined positions (pos_x, pos_y) otherwise.</span>

<span class="sd">        This method uses columns pos_x and pos_y (or refined_pos_x and refined_pos_y if</span>
<span class="sd">        available) to extract the boxes from the images. When using top-left reference</span>
<span class="sd">        position, the boxes are extracted as follows, where the dots represent the</span>
<span class="sd">        actual particle in the image</span>

<span class="sd">        Example:</span>
<span class="sd">            :                +----------------------------------+</span>
<span class="sd">            :                |                                  |</span>
<span class="sd">            :                |                                  |</span>
<span class="sd">            :                |     (x, y) *=== box_w ===+       |</span>
<span class="sd">            :                |            |             |       |</span>
<span class="sd">            :                |            |     ....  box_h     |</span>
<span class="sd">            :           img_height        |    ......   |       |</span>
<span class="sd">            :                |            |     ....    |       |</span>
<span class="sd">            :                |            |             |       |</span>
<span class="sd">            :                |            +=============+       |</span>
<span class="sd">            :                |                                  |</span>
<span class="sd">            :                +------------ img_width -----------+</span>

<span class="sd">        When center reference is used, then the position columns in the DataFrame are</span>
<span class="sd">        interpreted as the center of the particle, and the boxes are extracted around</span>
<span class="sd">        this x and y position as follows:</span>

<span class="sd">        Example:</span>
<span class="sd">            :                +----------------------------------+</span>
<span class="sd">            :                |                                  |</span>
<span class="sd">            :                |                                  |</span>
<span class="sd">            :                |            +=== box_w ===+       |</span>
<span class="sd">            :                |            |             |       |</span>
<span class="sd">            :                |            |     ....    |       |</span>
<span class="sd">            :           img_height        |(x, y).*.. box_h     |</span>
<span class="sd">            :                |            |     ....    |       |</span>
<span class="sd">            :                |            |             |       |</span>
<span class="sd">            :                |            +=============+       |</span>
<span class="sd">            :                |                                  |</span>
<span class="sd">            :                +------------ img_width -----------+</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pos_reference : Literal[&quot;center&quot;, &quot;top-left&quot;], optional</span>
<span class="sd">            The reference point for the positions, by default &quot;top-left&quot;. If &quot;center&quot;,</span>
<span class="sd">            the boxes extracted will be</span>
<span class="sd">            image[y - box_size // 2 : y + box_size // 2, ...].</span>
<span class="sd">            Columns in the dataframe which are used as position references are always</span>
<span class="sd">            pos_x and pos_y, or refined_pos_x and refined_pos_y if available.</span>
<span class="sd">            If &quot;top-left&quot;, the boxes will be image[y : y + box_size, ...].</span>
<span class="sd">            Leopard-EM uses the &quot;top-left&quot; reference position, and unless you know data</span>
<span class="sd">            was processed in a different way you should not change this value.</span>
<span class="sd">        handle_bounds : Literal[&quot;pad&quot;, &quot;clip&quot;, &quot;error&quot;], optional</span>
<span class="sd">            How to handle the bounds of the image, by default &quot;pad&quot;. If &quot;pad&quot;, the image</span>
<span class="sd">            will be padded with the padding value based on the padding mode. If &quot;error&quot;,</span>
<span class="sd">            an error will be raised if any region exceeds the image bounds. NOTE:</span>
<span class="sd">            clipping is not supported since returned stack may have inhomogeneous sizes.</span>
<span class="sd">        padding_mode : Literal[&quot;constant&quot;, &quot;reflect&quot;, &quot;replicate&quot;], optional</span>
<span class="sd">            The padding mode to use when padding the image, by default &quot;constant&quot;.</span>
<span class="sd">            &quot;constant&quot; pads with the value `padding_value`, &quot;reflect&quot; pads with the</span>
<span class="sd">            reflection of the image at the edge, and &quot;replicate&quot; pads with the last</span>
<span class="sd">            pixel of the image. These match the modes available in</span>
<span class="sd">            `torch.nn.functional.pad`.</span>
<span class="sd">        padding_value : float, optional</span>
<span class="sd">            The value to use for padding when `padding_mode` is &quot;constant&quot;, by default</span>
<span class="sd">            0.0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            The stack of images, this is the internal &#39;image_stack&#39; attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine which position columns to use (refined if available)</span>
        <span class="n">y_col</span><span class="p">,</span> <span class="n">x_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_position_reference_columns</span><span class="p">()</span>

        <span class="c1"># Create an empty tensor to store the image stack</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_template_size</span>
        <span class="n">box_h</span><span class="p">,</span> <span class="n">box_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_box_size</span>
        <span class="n">image_stack</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_particles</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">extracted_box_size</span><span class="p">))</span>

        <span class="c1"># Find the indexes in the DataFrame that correspond to each unique image</span>
        <span class="n">image_index_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;micrograph_path&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span>
        <span class="k">for</span> <span class="n">img_path</span><span class="p">,</span> <span class="n">indexes</span> <span class="ow">in</span> <span class="n">image_index_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">load_mrc_image</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>

            <span class="n">pos_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indexes</span><span class="p">,</span> <span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">pos_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indexes</span><span class="p">,</span> <span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

            <span class="c1"># If the position reference is &quot;center&quot;, shift (x, y) by half the original</span>
            <span class="c1"># template width/height so reference is now the top-left corner</span>
            <span class="k">if</span> <span class="n">pos_reference</span> <span class="o">==</span> <span class="s2">&quot;center&quot;</span><span class="p">:</span>
                <span class="n">pos_y</span> <span class="o">=</span> <span class="n">pos_y</span> <span class="o">-</span> <span class="n">h</span> <span class="o">//</span> <span class="mi">2</span>
                <span class="n">pos_x</span> <span class="o">=</span> <span class="n">pos_x</span> <span class="o">-</span> <span class="n">w</span> <span class="o">//</span> <span class="mi">2</span>

            <span class="c1"># Our reference is now a top-left corner of a box of the original template</span>
            <span class="c1"># shape, BUT we want a slightly larger box of extracted_box_size AND this</span>
            <span class="c1"># box to be centered around the particle. Therefore, need to shift the</span>
            <span class="c1"># position half the difference between the original template size and</span>
            <span class="c1"># the extracted box size.</span>
            <span class="n">pos_y</span> <span class="o">-=</span> <span class="p">(</span><span class="n">box_h</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">pos_x</span> <span class="o">-=</span> <span class="p">(</span><span class="n">box_w</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

            <span class="n">pos_y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos_y</span><span class="p">)</span>
            <span class="n">pos_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos_x</span><span class="p">)</span>

            <span class="c1"># Code logic is simplified by only using the top-left reference position</span>
            <span class="c1"># in the `get_cropped_image_regions` function. Relative referencing handled</span>
            <span class="c1"># by the ParticleStack class.</span>
            <span class="n">cropped_images</span> <span class="o">=</span> <span class="n">get_cropped_image_regions</span><span class="p">(</span>
                <span class="n">img</span><span class="p">,</span>
                <span class="n">pos_y</span><span class="p">,</span>
                <span class="n">pos_x</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">extracted_box_size</span><span class="p">,</span>
                <span class="n">pos_reference</span><span class="o">=</span><span class="s2">&quot;top-left&quot;</span><span class="p">,</span>
                <span class="n">handle_bounds</span><span class="o">=</span><span class="n">handle_bounds</span><span class="p">,</span>
                <span class="n">padding_mode</span><span class="o">=</span><span class="n">padding_mode</span><span class="p">,</span>
                <span class="n">padding_value</span><span class="o">=</span><span class="n">padding_value</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">image_stack</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span> <span class="o">=</span> <span class="n">cropped_images</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_stack</span> <span class="o">=</span> <span class="n">image_stack</span>

        <span class="k">return</span> <span class="n">image_stack</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">construct_cropped_statistic_stack</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">stat</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
            <span class="s2">&quot;mip&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scaled_mip&quot;</span><span class="p">,</span>
            <span class="s2">&quot;correlation_average&quot;</span><span class="p">,</span>
            <span class="s2">&quot;correlation_variance&quot;</span><span class="p">,</span>
            <span class="s2">&quot;defocus&quot;</span><span class="p">,</span>
            <span class="s2">&quot;psi&quot;</span><span class="p">,</span>
            <span class="s2">&quot;theta&quot;</span><span class="p">,</span>
            <span class="s2">&quot;phi&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">handle_bounds</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;pad&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pad&quot;</span><span class="p">,</span>
        <span class="n">padding_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="s2">&quot;reflect&quot;</span><span class="p">,</span> <span class="s2">&quot;replicate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;constant&quot;</span><span class="p">,</span>
        <span class="n">padding_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a tensor of the specified statistic for each cropped image.</span>

<span class="sd">        NOTE: This function is very similar to `construct_image_stack` but returns the</span>
<span class="sd">        statistic in one of the result maps. Shape here is (N, H - h + 1, W - w + 1).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stat : Literal[&quot;mip&quot;, &quot;scaled_mip&quot;, &quot;correlation_average&quot;,</span>
<span class="sd">            &quot;correlation_variance&quot;, &quot;defocus&quot;, &quot;psi&quot;, &quot;theta&quot;, &quot;phi&quot;]</span>
<span class="sd">            The statistic to extract from the DataFrame.</span>
<span class="sd">        handle_bounds : Literal[&quot;pad&quot;, &quot;clip&quot;, &quot;error&quot;], optional</span>
<span class="sd">            How to handle the bounds of the image, by default &quot;pad&quot;. If &quot;pad&quot;, the image</span>
<span class="sd">            will be padded with the padding value based on the padding mode. If &quot;error&quot;,</span>
<span class="sd">            an error will be raised if any region exceeds the image bounds. NOTE:</span>
<span class="sd">            clipping is not supported since returned stack may have inhomogeneous sizes.</span>
<span class="sd">        padding_mode : Literal[&quot;constant&quot;, &quot;reflect&quot;, &quot;replicate&quot;], optional</span>
<span class="sd">            The padding mode to use when padding the image, by default &quot;constant&quot;.</span>
<span class="sd">            &quot;constant&quot; pads with the value `padding_value`, &quot;reflect&quot; pads with the</span>
<span class="sd">            reflection of the image at the edge, and &quot;replicate&quot; pads with the last</span>
<span class="sd">            pixel of the image. These match the modes available in</span>
<span class="sd">            `torch.nn.functional.pad`.</span>
<span class="sd">        padding_value : float, optional</span>
<span class="sd">            The value to use for padding when `padding_mode` is &quot;constant&quot;, by default</span>
<span class="sd">            0.0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            The stack of statistics with shape (N, H - h + 1, W - w + 1) where N is the</span>
<span class="sd">            number of particles and (H, W) is the extracted box size with (h, w) being</span>
<span class="sd">            the original template size.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stat_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stat</span><span class="si">}</span><span class="s2">_path&quot;</span>
        <span class="n">y_col</span><span class="p">,</span> <span class="n">x_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_position_reference_columns</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">stat_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Statistic &#39;</span><span class="si">{</span><span class="n">stat</span><span class="si">}</span><span class="s2">&#39; not found in the DataFrame.&quot;</span><span class="p">)</span>

        <span class="c1"># Create an empty tensor to store the stat stack</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_template_size</span>
        <span class="n">box_h</span><span class="p">,</span> <span class="n">box_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_box_size</span>
        <span class="n">stat_stack</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_particles</span><span class="p">,</span> <span class="n">box_h</span> <span class="o">-</span> <span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">box_w</span> <span class="o">-</span> <span class="n">w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Find the indexes in the DataFrame that correspond to each unique stat map</span>
        <span class="n">stat_index_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">stat_col</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span>

        <span class="c1"># Loop over each unique stat map and extract the particles</span>
        <span class="k">for</span> <span class="n">stat_path</span><span class="p">,</span> <span class="n">indexes</span> <span class="ow">in</span> <span class="n">stat_index_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">stat_map</span> <span class="o">=</span> <span class="n">load_mrc_image</span><span class="p">(</span><span class="n">stat_path</span><span class="p">)</span>

            <span class="c1"># with reference to the exact pixel of the statistic (top-left)</span>
            <span class="c1"># need to account for relative extracted box size</span>
            <span class="n">pos_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indexes</span><span class="p">,</span> <span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">pos_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indexes</span><span class="p">,</span> <span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

            <span class="c1"># NOTE: For both references, we need to shift both x and y</span>
            <span class="c1"># by half the different of the original template shape and extracted box</span>
            <span class="c1"># so that the padding around the statistic peak is symmetric.</span>
            <span class="n">pos_y</span> <span class="o">-=</span> <span class="p">(</span><span class="n">box_h</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">pos_x</span> <span class="o">-=</span> <span class="p">(</span><span class="n">box_w</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

            <span class="n">pos_y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos_y</span><span class="p">)</span>
            <span class="n">pos_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos_x</span><span class="p">)</span>

            <span class="n">cropped_stat_maps</span> <span class="o">=</span> <span class="n">get_cropped_image_regions</span><span class="p">(</span>
                <span class="n">stat_map</span><span class="p">,</span>
                <span class="n">pos_y</span><span class="p">,</span>
                <span class="n">pos_x</span><span class="p">,</span>
                <span class="p">(</span><span class="n">box_h</span> <span class="o">-</span> <span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">box_w</span> <span class="o">-</span> <span class="n">w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">pos_reference</span><span class="o">=</span><span class="s2">&quot;top-left&quot;</span><span class="p">,</span>
                <span class="n">handle_bounds</span><span class="o">=</span><span class="n">handle_bounds</span><span class="p">,</span>
                <span class="n">padding_mode</span><span class="o">=</span><span class="n">padding_mode</span><span class="p">,</span>
                <span class="n">padding_value</span><span class="o">=</span><span class="n">padding_value</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">stat_stack</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span> <span class="o">=</span> <span class="n">cropped_stat_maps</span>

        <span class="k">return</span> <span class="n">stat_stack</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">construct_filter_stack</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">preprocess_filters</span><span class="p">:</span> <span class="n">PreprocessingFilters</span><span class="p">,</span> <span class="n">output_shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get stack of Fourier filters from filter config and reference micrographs.</span>

<span class="sd">        Note that here the filters are assumed to be applied globally (i.e. no local</span>
<span class="sd">        whitening, etc. is being done). Whitening filters are calculated with reference</span>
<span class="sd">        to each original micrograph in the DataFrame.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        preprocess_filters : PreprocessingFilters</span>
<span class="sd">            Configuration object of filters to apply.</span>
<span class="sd">        output_shape : tuple[int, int]</span>
<span class="sd">            What shape along the last two dimensions the filters should be.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            The stack of filters with shape (N, h, w) where N is the number of particles</span>
<span class="sd">            and (h, w) is the output shape.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create an empty tensor to store the filter stack</span>
        <span class="n">filter_stack</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_particles</span><span class="p">,</span> <span class="o">*</span><span class="n">output_shape</span><span class="p">))</span>

        <span class="c1"># Find the indexes in the DataFrame that correspond to each unique image</span>
        <span class="n">image_index_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;micrograph_path&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span>

        <span class="c1"># Loop over each unique image and extract the particles</span>
        <span class="k">for</span> <span class="n">img_path</span><span class="p">,</span> <span class="n">indexes</span> <span class="ow">in</span> <span class="n">image_index_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">load_mrc_image</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>

            <span class="n">image_dft</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftn</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>  <span class="c1"># pylint: disable=not-callable</span>
            <span class="n">image_dft</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">0</span><span class="n">j</span>
            <span class="n">cumulative_filter</span> <span class="o">=</span> <span class="n">preprocess_filters</span><span class="o">.</span><span class="n">get_combined_filter</span><span class="p">(</span>
                <span class="n">ref_img_rfft</span><span class="o">=</span><span class="n">image_dft</span><span class="p">,</span>
                <span class="n">output_shape</span><span class="o">=</span><span class="n">output_shape</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">filter_stack</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span> <span class="o">=</span> <span class="n">cumulative_filter</span>

        <span class="k">return</span> <span class="n">filter_stack</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">df_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the columns of the DataFrame.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_particles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the number of particles in the stack.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_relative_defocus</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prefer_refined_defocus</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the relative defocus values for each particle.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prefer_refined_defocus : bool, optional</span>
<span class="sd">            Whether to use the refined defocus values (columns prefixed with &#39;refined_&#39;)</span>
<span class="sd">            or not, by default True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            The relative defocus values for each particle.</span>

<span class="sd">        Warnings</span>
<span class="sd">        --------</span>
<span class="sd">            Warns if NaN values or no column present for either</span>
<span class="sd">            &#39;refined_relative_defocus&#39; or &#39;relative_defocus&#39;.</span>
<span class="sd">            Falls back to the unrefined values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rel_defocus_col</span> <span class="o">=</span> <span class="s2">&quot;relative_defocus&quot;</span>
        <span class="c1"># Both refined columns must be present AND no values can be NaN or inf</span>
        <span class="k">if</span> <span class="n">prefer_refined_defocus</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;refined_relative_defocus&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Refined defocus values not found in DataFrame, using original &quot;</span>
                    <span class="s2">&quot;defocus values...&quot;</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">_any_nan_or_inf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;refined_relative_defocus&quot;</span><span class="p">]):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Refined defocus values contain NaN or inf values, using original &quot;</span>
                    <span class="s2">&quot;defocus values...&quot;</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rel_defocus_col</span> <span class="o">=</span> <span class="s2">&quot;refined_relative_defocus&quot;</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="n">rel_defocus_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_absolute_defocus</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prefer_refined_defocus</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the absolute defocus values for each particle.</span>

<span class="sd">        NOTE: If the refined defocus values are requested but not present in the</span>
<span class="sd">        DataFrame (either no column or any NaN values), a user warning is raised</span>
<span class="sd">        and the original defocus values are returned instead.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prefer_refined_defocus : bool, optional</span>
<span class="sd">            Whether to use the refined defocus values</span>
<span class="sd">            (columns prefixed with &#39;refined_&#39;) or not, by default True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[torch.Tensor, torch.Tensor]</span>
<span class="sd">            A tuple of two tensors containing the absolute defocus values along the</span>
<span class="sd">            major (defocus_u) and minor axes (defocus_v), respectively in units of</span>
<span class="sd">            Angstroms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">particle_defocus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relative_defocus</span><span class="p">(</span><span class="n">prefer_refined_defocus</span><span class="p">)</span>
        <span class="n">defocus_u</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;defocus_u&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span> <span class="o">+</span> <span class="n">particle_defocus</span>
        <span class="n">defocus_v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;defocus_v&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span> <span class="o">+</span> <span class="n">particle_defocus</span>

        <span class="k">return</span> <span class="n">defocus_u</span><span class="p">,</span> <span class="n">defocus_v</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_pixel_size</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prefer_refined_pixel_size</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the relative pixel size values for each particle.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prefer_refined_pixel_size : bool, optional</span>
<span class="sd">            Whether to use the refined pixel size values</span>
<span class="sd">            (columns prefixed with &#39;refined_&#39;) or not, by default True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            The relative pixel size values for each particle.</span>

<span class="sd">        Warnings</span>
<span class="sd">        --------</span>
<span class="sd">            Warns if NaN values or no column present for either &#39;refined_pixel_size&#39;</span>
<span class="sd">            or &#39;pixel_size&#39;. Falls back to the unrefined values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pixel_size_col</span> <span class="o">=</span> <span class="s2">&quot;pixel_size&quot;</span>
        <span class="k">if</span> <span class="n">prefer_refined_pixel_size</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;refined_pixel_size&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Refined pixel size not found in DataFrame, using original&quot;</span>
                    <span class="s2">&quot; pixel size values...&quot;</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">_any_nan_or_inf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;refined_pixel_size&quot;</span><span class="p">]):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Refined pixel size contain NaN or inf values, using original&quot;</span>
                    <span class="s2">&quot; pixel size values...&quot;</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pixel_size_col</span> <span class="o">=</span> <span class="s2">&quot;refined_pixel_size&quot;</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="n">pixel_size_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_euler_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefer_refined_angles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the Euler angles (phi, theta, psi) of all particles as a tensor.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prefer_refined_angles : bool, optional</span>
<span class="sd">            When true, the refined Euler angles are used (columns prefixed with</span>
<span class="sd">            &#39;refined_&#39;), otherwise the original angles are used, by default True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            A tensor of shape (N, 3) where N is the number of particles and the columns</span>
<span class="sd">            correspond to (phi, theta, psi) in ZYZ format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure all three refined columns are present, warning if not</span>
        <span class="n">phi_col</span> <span class="o">=</span> <span class="s2">&quot;phi&quot;</span>
        <span class="n">theta_col</span> <span class="o">=</span> <span class="s2">&quot;theta&quot;</span>
        <span class="n">psi_col</span> <span class="o">=</span> <span class="s2">&quot;psi&quot;</span>
        <span class="k">if</span> <span class="n">prefer_refined_angles</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
                <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;refined_phi&quot;</span><span class="p">,</span> <span class="s2">&quot;refined_theta&quot;</span><span class="p">,</span> <span class="s2">&quot;refined_psi&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Refined angles not found in DataFrame, using original angles...&quot;</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phi_col</span> <span class="o">=</span> <span class="s2">&quot;refined_phi&quot;</span>
                <span class="n">theta_col</span> <span class="o">=</span> <span class="s2">&quot;refined_theta&quot;</span>
                <span class="n">psi_col</span> <span class="o">=</span> <span class="s2">&quot;refined_psi&quot;</span>

        <span class="c1"># Get the angles from the DataFrame</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="n">phi_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="n">theta_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="n">psi_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">psi</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get an item from the DataFrame.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; not found in underlying DataFrame.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set a column in the underlying DataFrame.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        column_name : str</span>
<span class="sd">            The name of the column to set</span>
<span class="sd">        value : Any</span>
<span class="sd">            The value to set the column to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_dataframe_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a copy of the underlying DataFrame.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">        A copy of the underlying DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="leopard_em.pydantic_models.data_structures.ParticleStack.df_columns" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">df_columns</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Get the columns of the DataFrame.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="leopard_em.pydantic_models.data_structures.ParticleStack.num_particles" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">num_particles</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Get the number of particles in the stack.</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h3 id="leopard_em.pydantic_models.data_structures.ParticleStack.__getitem__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get an item from the DataFrame.</p>


            <details class="quote">
              <summary>Source code in <code>src/leopard_em/pydantic_models/data_structures/particle_stack.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get an item from the DataFrame.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; not found in underlying DataFrame.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="leopard_em.pydantic_models.data_structures.ParticleStack.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">skip_df_load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize the ParticleStack object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>skip_df_load</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to skip loading the DataFrame, by default False and the dataframe
is loaded automatically.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The data to initialize the object with.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/leopard_em/pydantic_models/data_structures/particle_stack.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_df_load</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the ParticleStack object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    skip_df_load : bool, optional</span>
<span class="sd">        Whether to skip loading the DataFrame, by default False and the dataframe</span>
<span class="sd">        is loaded automatically.</span>
<span class="sd">    data : dict[str, Any]</span>
<span class="sd">        The data to initialize the object with.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_df_load</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_df</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="leopard_em.pydantic_models.data_structures.ParticleStack.construct_cropped_statistic_stack" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">construct_cropped_statistic_stack</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">handle_bounds</span><span class="o">=</span><span class="s1">&#39;pad&#39;</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">padding_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return a tensor of the specified statistic for each cropped image.</p>
<p>NOTE: This function is very similar to <code>construct_image_stack</code> but returns the
statistic in one of the result maps. Shape here is (N, H - h + 1, W - w + 1).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>stat</code>
            </td>
            <td>
                  <code>Literal[&#34;mip&#34;, &#34;scaled_mip&#34;, &#34;correlation_average&#34;,</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>"correlation_variance", "defocus", "psi", "theta", "phi"]
The statistic to extract from the DataFrame.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>handle_bounds</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;pad&#39;, &#39;clip&#39;, &#39;error&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How to handle the bounds of the image, by default "pad". If "pad", the image
will be padded with the padding value based on the padding mode. If "error",
an error will be raised if any region exceeds the image bounds. NOTE:
clipping is not supported since returned stack may have inhomogeneous sizes.</p>
              </div>
            </td>
            <td>
                  <code>&#39;pad&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>padding_mode</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;constant&#39;, &#39;reflect&#39;, &#39;replicate&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The padding mode to use when padding the image, by default "constant".
"constant" pads with the value <code>padding_value</code>, "reflect" pads with the
reflection of the image at the edge, and "replicate" pads with the last
pixel of the image. These match the modes available in
<code>torch.nn.functional.pad</code>.</p>
              </div>
            </td>
            <td>
                  <code>&#39;constant&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>padding_value</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The value to use for padding when <code>padding_mode</code> is "constant", by default
0.0.</p>
              </div>
            </td>
            <td>
                  <code>0.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The stack of statistics with shape (N, H - h + 1, W - w + 1) where N is the
number of particles and (H, W) is the extracted box size with (h, w) being
the original template size.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/leopard_em/pydantic_models/data_structures/particle_stack.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">construct_cropped_statistic_stack</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">stat</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
        <span class="s2">&quot;mip&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scaled_mip&quot;</span><span class="p">,</span>
        <span class="s2">&quot;correlation_average&quot;</span><span class="p">,</span>
        <span class="s2">&quot;correlation_variance&quot;</span><span class="p">,</span>
        <span class="s2">&quot;defocus&quot;</span><span class="p">,</span>
        <span class="s2">&quot;psi&quot;</span><span class="p">,</span>
        <span class="s2">&quot;theta&quot;</span><span class="p">,</span>
        <span class="s2">&quot;phi&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">handle_bounds</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;pad&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pad&quot;</span><span class="p">,</span>
    <span class="n">padding_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="s2">&quot;reflect&quot;</span><span class="p">,</span> <span class="s2">&quot;replicate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;constant&quot;</span><span class="p">,</span>
    <span class="n">padding_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a tensor of the specified statistic for each cropped image.</span>

<span class="sd">    NOTE: This function is very similar to `construct_image_stack` but returns the</span>
<span class="sd">    statistic in one of the result maps. Shape here is (N, H - h + 1, W - w + 1).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stat : Literal[&quot;mip&quot;, &quot;scaled_mip&quot;, &quot;correlation_average&quot;,</span>
<span class="sd">        &quot;correlation_variance&quot;, &quot;defocus&quot;, &quot;psi&quot;, &quot;theta&quot;, &quot;phi&quot;]</span>
<span class="sd">        The statistic to extract from the DataFrame.</span>
<span class="sd">    handle_bounds : Literal[&quot;pad&quot;, &quot;clip&quot;, &quot;error&quot;], optional</span>
<span class="sd">        How to handle the bounds of the image, by default &quot;pad&quot;. If &quot;pad&quot;, the image</span>
<span class="sd">        will be padded with the padding value based on the padding mode. If &quot;error&quot;,</span>
<span class="sd">        an error will be raised if any region exceeds the image bounds. NOTE:</span>
<span class="sd">        clipping is not supported since returned stack may have inhomogeneous sizes.</span>
<span class="sd">    padding_mode : Literal[&quot;constant&quot;, &quot;reflect&quot;, &quot;replicate&quot;], optional</span>
<span class="sd">        The padding mode to use when padding the image, by default &quot;constant&quot;.</span>
<span class="sd">        &quot;constant&quot; pads with the value `padding_value`, &quot;reflect&quot; pads with the</span>
<span class="sd">        reflection of the image at the edge, and &quot;replicate&quot; pads with the last</span>
<span class="sd">        pixel of the image. These match the modes available in</span>
<span class="sd">        `torch.nn.functional.pad`.</span>
<span class="sd">    padding_value : float, optional</span>
<span class="sd">        The value to use for padding when `padding_mode` is &quot;constant&quot;, by default</span>
<span class="sd">        0.0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        The stack of statistics with shape (N, H - h + 1, W - w + 1) where N is the</span>
<span class="sd">        number of particles and (H, W) is the extracted box size with (h, w) being</span>
<span class="sd">        the original template size.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stat_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stat</span><span class="si">}</span><span class="s2">_path&quot;</span>
    <span class="n">y_col</span><span class="p">,</span> <span class="n">x_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_position_reference_columns</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">stat_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Statistic &#39;</span><span class="si">{</span><span class="n">stat</span><span class="si">}</span><span class="s2">&#39; not found in the DataFrame.&quot;</span><span class="p">)</span>

    <span class="c1"># Create an empty tensor to store the stat stack</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_template_size</span>
    <span class="n">box_h</span><span class="p">,</span> <span class="n">box_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_box_size</span>
    <span class="n">stat_stack</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_particles</span><span class="p">,</span> <span class="n">box_h</span> <span class="o">-</span> <span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">box_w</span> <span class="o">-</span> <span class="n">w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Find the indexes in the DataFrame that correspond to each unique stat map</span>
    <span class="n">stat_index_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">stat_col</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span>

    <span class="c1"># Loop over each unique stat map and extract the particles</span>
    <span class="k">for</span> <span class="n">stat_path</span><span class="p">,</span> <span class="n">indexes</span> <span class="ow">in</span> <span class="n">stat_index_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">stat_map</span> <span class="o">=</span> <span class="n">load_mrc_image</span><span class="p">(</span><span class="n">stat_path</span><span class="p">)</span>

        <span class="c1"># with reference to the exact pixel of the statistic (top-left)</span>
        <span class="c1"># need to account for relative extracted box size</span>
        <span class="n">pos_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indexes</span><span class="p">,</span> <span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">pos_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indexes</span><span class="p">,</span> <span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># NOTE: For both references, we need to shift both x and y</span>
        <span class="c1"># by half the different of the original template shape and extracted box</span>
        <span class="c1"># so that the padding around the statistic peak is symmetric.</span>
        <span class="n">pos_y</span> <span class="o">-=</span> <span class="p">(</span><span class="n">box_h</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">pos_x</span> <span class="o">-=</span> <span class="p">(</span><span class="n">box_w</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="n">pos_y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos_y</span><span class="p">)</span>
        <span class="n">pos_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos_x</span><span class="p">)</span>

        <span class="n">cropped_stat_maps</span> <span class="o">=</span> <span class="n">get_cropped_image_regions</span><span class="p">(</span>
            <span class="n">stat_map</span><span class="p">,</span>
            <span class="n">pos_y</span><span class="p">,</span>
            <span class="n">pos_x</span><span class="p">,</span>
            <span class="p">(</span><span class="n">box_h</span> <span class="o">-</span> <span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">box_w</span> <span class="o">-</span> <span class="n">w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">pos_reference</span><span class="o">=</span><span class="s2">&quot;top-left&quot;</span><span class="p">,</span>
            <span class="n">handle_bounds</span><span class="o">=</span><span class="n">handle_bounds</span><span class="p">,</span>
            <span class="n">padding_mode</span><span class="o">=</span><span class="n">padding_mode</span><span class="p">,</span>
            <span class="n">padding_value</span><span class="o">=</span><span class="n">padding_value</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">stat_stack</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span> <span class="o">=</span> <span class="n">cropped_stat_maps</span>

    <span class="k">return</span> <span class="n">stat_stack</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="leopard_em.pydantic_models.data_structures.ParticleStack.construct_filter_stack" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">construct_filter_stack</span><span class="p">(</span><span class="n">preprocess_filters</span><span class="p">,</span> <span class="n">output_shape</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get stack of Fourier filters from filter config and reference micrographs.</p>
<p>Note that here the filters are assumed to be applied globally (i.e. no local
whitening, etc. is being done). Whitening filters are calculated with reference
to each original micrograph in the DataFrame.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>preprocess_filters</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="PreprocessingFilters (leopard_em.pydantic_models.config.PreprocessingFilters)" href="../config/#leopard_em.pydantic_models.config.PreprocessingFilters">PreprocessingFilters</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configuration object of filters to apply.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_shape</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>What shape along the last two dimensions the filters should be.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The stack of filters with shape (N, h, w) where N is the number of particles
and (h, w) is the output shape.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/leopard_em/pydantic_models/data_structures/particle_stack.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">construct_filter_stack</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">preprocess_filters</span><span class="p">:</span> <span class="n">PreprocessingFilters</span><span class="p">,</span> <span class="n">output_shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get stack of Fourier filters from filter config and reference micrographs.</span>

<span class="sd">    Note that here the filters are assumed to be applied globally (i.e. no local</span>
<span class="sd">    whitening, etc. is being done). Whitening filters are calculated with reference</span>
<span class="sd">    to each original micrograph in the DataFrame.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    preprocess_filters : PreprocessingFilters</span>
<span class="sd">        Configuration object of filters to apply.</span>
<span class="sd">    output_shape : tuple[int, int]</span>
<span class="sd">        What shape along the last two dimensions the filters should be.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        The stack of filters with shape (N, h, w) where N is the number of particles</span>
<span class="sd">        and (h, w) is the output shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create an empty tensor to store the filter stack</span>
    <span class="n">filter_stack</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_particles</span><span class="p">,</span> <span class="o">*</span><span class="n">output_shape</span><span class="p">))</span>

    <span class="c1"># Find the indexes in the DataFrame that correspond to each unique image</span>
    <span class="n">image_index_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;micrograph_path&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span>

    <span class="c1"># Loop over each unique image and extract the particles</span>
    <span class="k">for</span> <span class="n">img_path</span><span class="p">,</span> <span class="n">indexes</span> <span class="ow">in</span> <span class="n">image_index_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">load_mrc_image</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>

        <span class="n">image_dft</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftn</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>  <span class="c1"># pylint: disable=not-callable</span>
        <span class="n">image_dft</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">0</span><span class="n">j</span>
        <span class="n">cumulative_filter</span> <span class="o">=</span> <span class="n">preprocess_filters</span><span class="o">.</span><span class="n">get_combined_filter</span><span class="p">(</span>
            <span class="n">ref_img_rfft</span><span class="o">=</span><span class="n">image_dft</span><span class="p">,</span>
            <span class="n">output_shape</span><span class="o">=</span><span class="n">output_shape</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">filter_stack</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span> <span class="o">=</span> <span class="n">cumulative_filter</span>

    <span class="k">return</span> <span class="n">filter_stack</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="leopard_em.pydantic_models.data_structures.ParticleStack.construct_image_stack" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">construct_image_stack</span><span class="p">(</span><span class="n">pos_reference</span><span class="o">=</span><span class="s1">&#39;top-left&#39;</span><span class="p">,</span> <span class="n">handle_bounds</span><span class="o">=</span><span class="s1">&#39;pad&#39;</span><span class="p">,</span> <span class="n">padding_mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">padding_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Construct stack of images from the DataFrame (updates image_stack in-place).</p>
<p>This method preferentially selects refined position columns by default
(refined_pos_x, refined_pos_y) if they are present in the DataFrame, falling
back to unrefined positions (pos_x, pos_y) otherwise.</p>
<p>This method uses columns pos_x and pos_y (or refined_pos_x and refined_pos_y if
available) to extract the boxes from the images. When using top-left reference
position, the boxes are extracted as follows, where the dots represent the
actual particle in the image</p>
<p>Example:
    :                +----------------------------------+
    :                |                                  |
    :                |                                  |
    :                |     (x, y) *=== box_w ===+       |
    :                |            |             |       |
    :                |            |     ....  box_h     |
    :           img_height        |    ......   |       |
    :                |            |     ....    |       |
    :                |            |             |       |
    :                |            +=============+       |
    :                |                                  |
    :                +------------ img_width -----------+</p>
<p>When center reference is used, then the position columns in the DataFrame are
interpreted as the center of the particle, and the boxes are extracted around
this x and y position as follows:</p>
<p>Example:
    :                +----------------------------------+
    :                |                                  |
    :                |                                  |
    :                |            +=== box_w ===+       |
    :                |            |             |       |
    :                |            |     ....    |       |
    :           img_height        |(x, y).*.. box_h     |
    :                |            |     ....    |       |
    :                |            |             |       |
    :                |            +=============+       |
    :                |                                  |
    :                +------------ img_width -----------+</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pos_reference</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;center&#39;, &#39;top-left&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The reference point for the positions, by default "top-left". If "center",
the boxes extracted will be
image[y - box_size // 2 : y + box_size // 2, ...].
Columns in the dataframe which are used as position references are always
pos_x and pos_y, or refined_pos_x and refined_pos_y if available.
If "top-left", the boxes will be image[y : y + box_size, ...].
Leopard-EM uses the "top-left" reference position, and unless you know data
was processed in a different way you should not change this value.</p>
              </div>
            </td>
            <td>
                  <code>&#39;top-left&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>handle_bounds</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;pad&#39;, &#39;clip&#39;, &#39;error&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How to handle the bounds of the image, by default "pad". If "pad", the image
will be padded with the padding value based on the padding mode. If "error",
an error will be raised if any region exceeds the image bounds. NOTE:
clipping is not supported since returned stack may have inhomogeneous sizes.</p>
              </div>
            </td>
            <td>
                  <code>&#39;pad&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>padding_mode</code>
            </td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;constant&#39;, &#39;reflect&#39;, &#39;replicate&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The padding mode to use when padding the image, by default "constant".
"constant" pads with the value <code>padding_value</code>, "reflect" pads with the
reflection of the image at the edge, and "replicate" pads with the last
pixel of the image. These match the modes available in
<code>torch.nn.functional.pad</code>.</p>
              </div>
            </td>
            <td>
                  <code>&#39;constant&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>padding_value</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The value to use for padding when <code>padding_mode</code> is "constant", by default
0.0.</p>
              </div>
            </td>
            <td>
                  <code>0.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The stack of images, this is the internal 'image_stack' attribute.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/leopard_em/pydantic_models/data_structures/particle_stack.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">construct_image_stack</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">pos_reference</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="s2">&quot;top-left&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;top-left&quot;</span><span class="p">,</span>
    <span class="n">handle_bounds</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;pad&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pad&quot;</span><span class="p">,</span>
    <span class="n">padding_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="s2">&quot;reflect&quot;</span><span class="p">,</span> <span class="s2">&quot;replicate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;constant&quot;</span><span class="p">,</span>
    <span class="n">padding_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct stack of images from the DataFrame (updates image_stack in-place).</span>

<span class="sd">    This method preferentially selects refined position columns by default</span>
<span class="sd">    (refined_pos_x, refined_pos_y) if they are present in the DataFrame, falling</span>
<span class="sd">    back to unrefined positions (pos_x, pos_y) otherwise.</span>

<span class="sd">    This method uses columns pos_x and pos_y (or refined_pos_x and refined_pos_y if</span>
<span class="sd">    available) to extract the boxes from the images. When using top-left reference</span>
<span class="sd">    position, the boxes are extracted as follows, where the dots represent the</span>
<span class="sd">    actual particle in the image</span>

<span class="sd">    Example:</span>
<span class="sd">        :                +----------------------------------+</span>
<span class="sd">        :                |                                  |</span>
<span class="sd">        :                |                                  |</span>
<span class="sd">        :                |     (x, y) *=== box_w ===+       |</span>
<span class="sd">        :                |            |             |       |</span>
<span class="sd">        :                |            |     ....  box_h     |</span>
<span class="sd">        :           img_height        |    ......   |       |</span>
<span class="sd">        :                |            |     ....    |       |</span>
<span class="sd">        :                |            |             |       |</span>
<span class="sd">        :                |            +=============+       |</span>
<span class="sd">        :                |                                  |</span>
<span class="sd">        :                +------------ img_width -----------+</span>

<span class="sd">    When center reference is used, then the position columns in the DataFrame are</span>
<span class="sd">    interpreted as the center of the particle, and the boxes are extracted around</span>
<span class="sd">    this x and y position as follows:</span>

<span class="sd">    Example:</span>
<span class="sd">        :                +----------------------------------+</span>
<span class="sd">        :                |                                  |</span>
<span class="sd">        :                |                                  |</span>
<span class="sd">        :                |            +=== box_w ===+       |</span>
<span class="sd">        :                |            |             |       |</span>
<span class="sd">        :                |            |     ....    |       |</span>
<span class="sd">        :           img_height        |(x, y).*.. box_h     |</span>
<span class="sd">        :                |            |     ....    |       |</span>
<span class="sd">        :                |            |             |       |</span>
<span class="sd">        :                |            +=============+       |</span>
<span class="sd">        :                |                                  |</span>
<span class="sd">        :                +------------ img_width -----------+</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pos_reference : Literal[&quot;center&quot;, &quot;top-left&quot;], optional</span>
<span class="sd">        The reference point for the positions, by default &quot;top-left&quot;. If &quot;center&quot;,</span>
<span class="sd">        the boxes extracted will be</span>
<span class="sd">        image[y - box_size // 2 : y + box_size // 2, ...].</span>
<span class="sd">        Columns in the dataframe which are used as position references are always</span>
<span class="sd">        pos_x and pos_y, or refined_pos_x and refined_pos_y if available.</span>
<span class="sd">        If &quot;top-left&quot;, the boxes will be image[y : y + box_size, ...].</span>
<span class="sd">        Leopard-EM uses the &quot;top-left&quot; reference position, and unless you know data</span>
<span class="sd">        was processed in a different way you should not change this value.</span>
<span class="sd">    handle_bounds : Literal[&quot;pad&quot;, &quot;clip&quot;, &quot;error&quot;], optional</span>
<span class="sd">        How to handle the bounds of the image, by default &quot;pad&quot;. If &quot;pad&quot;, the image</span>
<span class="sd">        will be padded with the padding value based on the padding mode. If &quot;error&quot;,</span>
<span class="sd">        an error will be raised if any region exceeds the image bounds. NOTE:</span>
<span class="sd">        clipping is not supported since returned stack may have inhomogeneous sizes.</span>
<span class="sd">    padding_mode : Literal[&quot;constant&quot;, &quot;reflect&quot;, &quot;replicate&quot;], optional</span>
<span class="sd">        The padding mode to use when padding the image, by default &quot;constant&quot;.</span>
<span class="sd">        &quot;constant&quot; pads with the value `padding_value`, &quot;reflect&quot; pads with the</span>
<span class="sd">        reflection of the image at the edge, and &quot;replicate&quot; pads with the last</span>
<span class="sd">        pixel of the image. These match the modes available in</span>
<span class="sd">        `torch.nn.functional.pad`.</span>
<span class="sd">    padding_value : float, optional</span>
<span class="sd">        The value to use for padding when `padding_mode` is &quot;constant&quot;, by default</span>
<span class="sd">        0.0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        The stack of images, this is the internal &#39;image_stack&#39; attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determine which position columns to use (refined if available)</span>
    <span class="n">y_col</span><span class="p">,</span> <span class="n">x_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_position_reference_columns</span><span class="p">()</span>

    <span class="c1"># Create an empty tensor to store the image stack</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_template_size</span>
    <span class="n">box_h</span><span class="p">,</span> <span class="n">box_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extracted_box_size</span>
    <span class="n">image_stack</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_particles</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">extracted_box_size</span><span class="p">))</span>

    <span class="c1"># Find the indexes in the DataFrame that correspond to each unique image</span>
    <span class="n">image_index_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;micrograph_path&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span>
    <span class="k">for</span> <span class="n">img_path</span><span class="p">,</span> <span class="n">indexes</span> <span class="ow">in</span> <span class="n">image_index_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">load_mrc_image</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>

        <span class="n">pos_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indexes</span><span class="p">,</span> <span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">pos_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indexes</span><span class="p">,</span> <span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># If the position reference is &quot;center&quot;, shift (x, y) by half the original</span>
        <span class="c1"># template width/height so reference is now the top-left corner</span>
        <span class="k">if</span> <span class="n">pos_reference</span> <span class="o">==</span> <span class="s2">&quot;center&quot;</span><span class="p">:</span>
            <span class="n">pos_y</span> <span class="o">=</span> <span class="n">pos_y</span> <span class="o">-</span> <span class="n">h</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">pos_x</span> <span class="o">=</span> <span class="n">pos_x</span> <span class="o">-</span> <span class="n">w</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="c1"># Our reference is now a top-left corner of a box of the original template</span>
        <span class="c1"># shape, BUT we want a slightly larger box of extracted_box_size AND this</span>
        <span class="c1"># box to be centered around the particle. Therefore, need to shift the</span>
        <span class="c1"># position half the difference between the original template size and</span>
        <span class="c1"># the extracted box size.</span>
        <span class="n">pos_y</span> <span class="o">-=</span> <span class="p">(</span><span class="n">box_h</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">pos_x</span> <span class="o">-=</span> <span class="p">(</span><span class="n">box_w</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="n">pos_y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos_y</span><span class="p">)</span>
        <span class="n">pos_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">pos_x</span><span class="p">)</span>

        <span class="c1"># Code logic is simplified by only using the top-left reference position</span>
        <span class="c1"># in the `get_cropped_image_regions` function. Relative referencing handled</span>
        <span class="c1"># by the ParticleStack class.</span>
        <span class="n">cropped_images</span> <span class="o">=</span> <span class="n">get_cropped_image_regions</span><span class="p">(</span>
            <span class="n">img</span><span class="p">,</span>
            <span class="n">pos_y</span><span class="p">,</span>
            <span class="n">pos_x</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extracted_box_size</span><span class="p">,</span>
            <span class="n">pos_reference</span><span class="o">=</span><span class="s2">&quot;top-left&quot;</span><span class="p">,</span>
            <span class="n">handle_bounds</span><span class="o">=</span><span class="n">handle_bounds</span><span class="p">,</span>
            <span class="n">padding_mode</span><span class="o">=</span><span class="n">padding_mode</span><span class="p">,</span>
            <span class="n">padding_value</span><span class="o">=</span><span class="n">padding_value</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">image_stack</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span> <span class="o">=</span> <span class="n">cropped_images</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">image_stack</span> <span class="o">=</span> <span class="n">image_stack</span>

    <span class="k">return</span> <span class="n">image_stack</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="leopard_em.pydantic_models.data_structures.ParticleStack.get_absolute_defocus" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_absolute_defocus</span><span class="p">(</span><span class="n">prefer_refined_defocus</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get the absolute defocus values for each particle.</p>
<p>NOTE: If the refined defocus values are requested but not present in the
DataFrame (either no column or any NaN values), a user warning is raised
and the original defocus values are returned instead.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prefer_refined_defocus</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use the refined defocus values
(columns prefixed with 'refined_') or not, by default True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="torch.Tensor">Tensor</span>, <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple of two tensors containing the absolute defocus values along the
major (defocus_u) and minor axes (defocus_v), respectively in units of
Angstroms.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/leopard_em/pydantic_models/data_structures/particle_stack.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_absolute_defocus</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">prefer_refined_defocus</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the absolute defocus values for each particle.</span>

<span class="sd">    NOTE: If the refined defocus values are requested but not present in the</span>
<span class="sd">    DataFrame (either no column or any NaN values), a user warning is raised</span>
<span class="sd">    and the original defocus values are returned instead.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prefer_refined_defocus : bool, optional</span>
<span class="sd">        Whether to use the refined defocus values</span>
<span class="sd">        (columns prefixed with &#39;refined_&#39;) or not, by default True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[torch.Tensor, torch.Tensor]</span>
<span class="sd">        A tuple of two tensors containing the absolute defocus values along the</span>
<span class="sd">        major (defocus_u) and minor axes (defocus_v), respectively in units of</span>
<span class="sd">        Angstroms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">particle_defocus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_relative_defocus</span><span class="p">(</span><span class="n">prefer_refined_defocus</span><span class="p">)</span>
    <span class="n">defocus_u</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;defocus_u&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span> <span class="o">+</span> <span class="n">particle_defocus</span>
    <span class="n">defocus_v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;defocus_v&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span> <span class="o">+</span> <span class="n">particle_defocus</span>

    <span class="k">return</span> <span class="n">defocus_u</span><span class="p">,</span> <span class="n">defocus_v</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="leopard_em.pydantic_models.data_structures.ParticleStack.get_dataframe_copy" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_dataframe_copy</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return a copy of the underlying DataFrame.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>A copy of the underlying DataFrame</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/leopard_em/pydantic_models/data_structures/particle_stack.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_dataframe_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a copy of the underlying DataFrame.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">    A copy of the underlying DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="leopard_em.pydantic_models.data_structures.ParticleStack.get_euler_angles" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_euler_angles</span><span class="p">(</span><span class="n">prefer_refined_angles</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Return the Euler angles (phi, theta, psi) of all particles as a tensor.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prefer_refined_angles</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When true, the refined Euler angles are used (columns prefixed with
'refined_'), otherwise the original angles are used, by default True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tensor of shape (N, 3) where N is the number of particles and the columns
correspond to (phi, theta, psi) in ZYZ format.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/leopard_em/pydantic_models/data_structures/particle_stack.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_euler_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefer_refined_angles</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the Euler angles (phi, theta, psi) of all particles as a tensor.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prefer_refined_angles : bool, optional</span>
<span class="sd">        When true, the refined Euler angles are used (columns prefixed with</span>
<span class="sd">        &#39;refined_&#39;), otherwise the original angles are used, by default True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        A tensor of shape (N, 3) where N is the number of particles and the columns</span>
<span class="sd">        correspond to (phi, theta, psi) in ZYZ format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ensure all three refined columns are present, warning if not</span>
    <span class="n">phi_col</span> <span class="o">=</span> <span class="s2">&quot;phi&quot;</span>
    <span class="n">theta_col</span> <span class="o">=</span> <span class="s2">&quot;theta&quot;</span>
    <span class="n">psi_col</span> <span class="o">=</span> <span class="s2">&quot;psi&quot;</span>
    <span class="k">if</span> <span class="n">prefer_refined_angles</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;refined_phi&quot;</span><span class="p">,</span> <span class="s2">&quot;refined_theta&quot;</span><span class="p">,</span> <span class="s2">&quot;refined_psi&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Refined angles not found in DataFrame, using original angles...&quot;</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phi_col</span> <span class="o">=</span> <span class="s2">&quot;refined_phi&quot;</span>
            <span class="n">theta_col</span> <span class="o">=</span> <span class="s2">&quot;refined_theta&quot;</span>
            <span class="n">psi_col</span> <span class="o">=</span> <span class="s2">&quot;refined_psi&quot;</span>

    <span class="c1"># Get the angles from the DataFrame</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="n">phi_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="n">theta_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="n">psi_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">psi</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="leopard_em.pydantic_models.data_structures.ParticleStack.get_pixel_size" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_pixel_size</span><span class="p">(</span><span class="n">prefer_refined_pixel_size</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get the relative pixel size values for each particle.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prefer_refined_pixel_size</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use the refined pixel size values
(columns prefixed with 'refined_') or not, by default True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The relative pixel size values for each particle.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="warning" open>
  <summary>Warnings</summary>
  <pre><code>Warns if NaN values or no column present for either 'refined_pixel_size'
or 'pixel_size'. Falls back to the unrefined values.
</code></pre>
</details>

            <details class="quote">
              <summary>Source code in <code>src/leopard_em/pydantic_models/data_structures/particle_stack.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_pixel_size</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">prefer_refined_pixel_size</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the relative pixel size values for each particle.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prefer_refined_pixel_size : bool, optional</span>
<span class="sd">        Whether to use the refined pixel size values</span>
<span class="sd">        (columns prefixed with &#39;refined_&#39;) or not, by default True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        The relative pixel size values for each particle.</span>

<span class="sd">    Warnings</span>
<span class="sd">    --------</span>
<span class="sd">        Warns if NaN values or no column present for either &#39;refined_pixel_size&#39;</span>
<span class="sd">        or &#39;pixel_size&#39;. Falls back to the unrefined values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pixel_size_col</span> <span class="o">=</span> <span class="s2">&quot;pixel_size&quot;</span>
    <span class="k">if</span> <span class="n">prefer_refined_pixel_size</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;refined_pixel_size&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Refined pixel size not found in DataFrame, using original&quot;</span>
                <span class="s2">&quot; pixel size values...&quot;</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">_any_nan_or_inf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;refined_pixel_size&quot;</span><span class="p">]):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Refined pixel size contain NaN or inf values, using original&quot;</span>
                <span class="s2">&quot; pixel size values...&quot;</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pixel_size_col</span> <span class="o">=</span> <span class="s2">&quot;refined_pixel_size&quot;</span>

    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="n">pixel_size_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="leopard_em.pydantic_models.data_structures.ParticleStack.get_relative_defocus" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_relative_defocus</span><span class="p">(</span><span class="n">prefer_refined_defocus</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Get the relative defocus values for each particle.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>prefer_refined_defocus</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use the refined defocus values (columns prefixed with 'refined_')
or not, by default True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="torch.Tensor">Tensor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The relative defocus values for each particle.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="warning" open>
  <summary>Warnings</summary>
  <pre><code>Warns if NaN values or no column present for either
'refined_relative_defocus' or 'relative_defocus'.
Falls back to the unrefined values.
</code></pre>
</details>

            <details class="quote">
              <summary>Source code in <code>src/leopard_em/pydantic_models/data_structures/particle_stack.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_relative_defocus</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">prefer_refined_defocus</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the relative defocus values for each particle.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prefer_refined_defocus : bool, optional</span>
<span class="sd">        Whether to use the refined defocus values (columns prefixed with &#39;refined_&#39;)</span>
<span class="sd">        or not, by default True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        The relative defocus values for each particle.</span>

<span class="sd">    Warnings</span>
<span class="sd">    --------</span>
<span class="sd">        Warns if NaN values or no column present for either</span>
<span class="sd">        &#39;refined_relative_defocus&#39; or &#39;relative_defocus&#39;.</span>
<span class="sd">        Falls back to the unrefined values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rel_defocus_col</span> <span class="o">=</span> <span class="s2">&quot;relative_defocus&quot;</span>
    <span class="c1"># Both refined columns must be present AND no values can be NaN or inf</span>
    <span class="k">if</span> <span class="n">prefer_refined_defocus</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;refined_relative_defocus&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Refined defocus values not found in DataFrame, using original &quot;</span>
                <span class="s2">&quot;defocus values...&quot;</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">_any_nan_or_inf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;refined_relative_defocus&quot;</span><span class="p">]):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Refined defocus values contain NaN or inf values, using original &quot;</span>
                <span class="s2">&quot;defocus values...&quot;</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rel_defocus_col</span> <span class="o">=</span> <span class="s2">&quot;refined_relative_defocus&quot;</span>

    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="n">rel_defocus_col</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="leopard_em.pydantic_models.data_structures.ParticleStack.load_df" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_df</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Load the DataFrame from the specified path.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the DataFrame is missing required columns.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/leopard_em/pydantic_models/data_structures/particle_stack.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the DataFrame from the specified path.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the DataFrame is missing required columns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_path</span><span class="p">)</span>

    <span class="c1"># Validate the DataFrame columns</span>
    <span class="n">missing_columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">MATCH_TEMPLATE_DF_COLUMN_ORDER</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tmp_df</span><span class="o">.</span><span class="n">columns</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">missing_columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Missing the following columns in DataFrame: </span><span class="si">{</span><span class="n">missing_columns</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">tmp_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="leopard_em.pydantic_models.data_structures.ParticleStack.set_column" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_column</span><span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Set a column in the underlying DataFrame.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>column_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the column to set</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The value to set the column to</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/leopard_em/pydantic_models/data_structures/particle_stack.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set a column in the underlying DataFrame.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    column_name : str</span>
<span class="sd">        The name of the column to set</span>
<span class="sd">    value : Any</span>
<span class="sd">        The value to set the column to</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["content.code.copy"], "search": "../../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>