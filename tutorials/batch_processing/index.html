
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../match_template_intro/">
      
      
        <link rel="next" href="../../examples/01_basic_configuration/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.5">
    
    
      
        <title>Batch Processing - Leopard-EM: Two-Dimensional Template Matching in Python</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8608ea7d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#processing-batches-of-micrographs-with-leopard-em" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Leopard-EM: Two-Dimensional Template Matching in Python" class="md-header__button md-logo" aria-label="Leopard-EM: Two-Dimensional Template Matching in Python" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Leopard-EM: Two-Dimensional Template Matching in Python
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Batch Processing
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Leopard-EM: Two-Dimensional Template Matching in Python" class="md-nav__button md-logo" aria-label="Leopard-EM: Two-Dimensional Template Matching in Python" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Leopard-EM: Two-Dimensional Template Matching in Python
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../match_template_intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2DTM Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Batch Processing
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Batch Processing
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pre-requisite-data-layout" class="md-nav__link">
    <span class="md-ellipsis">
      Pre-requisite data layout
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#base-yaml-configuration-file" class="md-nav__link">
    <span class="md-ellipsis">
      Base YAML configuration file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#populating-the-yaml-configuration-file" class="md-nav__link">
    <span class="md-ellipsis">
      Populating the YAML configuration file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-the-leopard-em-2dtm-script" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up the Leopard-EM 2DTM script
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wrapping-the-runs-into-a-slurm-array-job" class="md-nav__link">
    <span class="md-ellipsis">
      Wrapping the runs into a SLURM array job
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/01_basic_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuring Pydantic models in Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/02_extract_peak_info/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Extracting results from the template matching search
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/03_compare_scoring_metrics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Comparing 2DTM scoring metrics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/04_plotting_2dtm_results/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Visualizing 2DTM result
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/05_structure_reprojection/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Structure projections on an Image
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Programs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Programs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programs/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programs/match_template/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Match Template details
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programs/refine_template/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Refine Template details
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programs/optimize_template/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimize Template details
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../programs/constrained_search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Constrained Search details
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data_formats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Program Output Formats
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../autoapi/leopard_em/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    leopard_em
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1" id="__nav_7_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1">
            <span class="md-nav__icon md-icon"></span>
            leopard_em
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../autoapi/leopard_em/analysis/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    analysis
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_1" id="__nav_7_1_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_1">
            <span class="md-nav__icon md-icon"></span>
            analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/analysis/gev_fit_metric/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    gev_fit_metric
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/analysis/match_template_peaks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    match_template_peaks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/analysis/pvalue_metric/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pvalue_metric
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/analysis/utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/analysis/zscore_metric/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    zscore_metric
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../autoapi/leopard_em/backend/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    backend
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_2" id="__nav_7_1_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_2">
            <span class="md-nav__icon md-icon"></span>
            backend
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/backend/core_match_template/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    core_match_template
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/backend/core_refine_template/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    core_refine_template
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/backend/cross_correlation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cross_correlation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/backend/process_results/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    process_results
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/backend/utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../autoapi/leopard_em/pydantic_models/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    pydantic_models
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_3" id="__nav_7_1_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_3">
            <span class="md-nav__icon md-icon"></span>
            pydantic_models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_3_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../autoapi/leopard_em/pydantic_models/config/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    config
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_3_1" id="__nav_7_1_3_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_1_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_3_1">
            <span class="md-nav__icon md-icon"></span>
            config
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/pydantic_models/config/computational_config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    computational_config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/pydantic_models/config/correlation_filters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    correlation_filters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/pydantic_models/config/defocus_search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    defocus_search
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/pydantic_models/config/orientation_search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    orientation_search
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/pydantic_models/config/pixel_size_search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pixel_size_search
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/pydantic_models/custom_types/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    custom_types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_3_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../autoapi/leopard_em/pydantic_models/data_structures/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    data_structures
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_3_3" id="__nav_7_1_3_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_1_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_3_3">
            <span class="md-nav__icon md-icon"></span>
            data_structures
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/pydantic_models/data_structures/optics_group/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    optics_group
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/pydantic_models/data_structures/particle_stack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    particle_stack
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/pydantic_models/formats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    formats
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_3_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../autoapi/leopard_em/pydantic_models/managers/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    managers
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_3_5" id="__nav_7_1_3_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_1_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_3_5">
            <span class="md-nav__icon md-icon"></span>
            managers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/pydantic_models/managers/constrained_search_manager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    constrained_search_manager
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/pydantic_models/managers/match_template_manager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    match_template_manager
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/pydantic_models/managers/optimize_template_manager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    optimize_template_manager
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/pydantic_models/managers/refine_template_manager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    refine_template_manager
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_3_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../autoapi/leopard_em/pydantic_models/results/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    results
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_3_6" id="__nav_7_1_3_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_1_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_3_6">
            <span class="md-nav__icon md-icon"></span>
            results
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/pydantic_models/results/match_template_result/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    match_template_result
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/pydantic_models/utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../autoapi/leopard_em/utils/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    utils
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7_1_4" id="__nav_7_1_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_4">
            <span class="md-nav__icon md-icon"></span>
            utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/utils/cross_correlation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cross_correlation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/utils/data_io/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    data_io
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../autoapi/leopard_em/utils/fourier_slice/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    fourier_slice
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pre-requisite-data-layout" class="md-nav__link">
    <span class="md-ellipsis">
      Pre-requisite data layout
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#base-yaml-configuration-file" class="md-nav__link">
    <span class="md-ellipsis">
      Base YAML configuration file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#populating-the-yaml-configuration-file" class="md-nav__link">
    <span class="md-ellipsis">
      Populating the YAML configuration file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-the-leopard-em-2dtm-script" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up the Leopard-EM 2DTM script
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wrapping-the-runs-into-a-slurm-array-job" class="md-nav__link">
    <span class="md-ellipsis">
      Wrapping the runs into a SLURM array job
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="processing-batches-of-micrographs-with-leopard-em">Processing batches of micrographs with Leopard-EM</h1>
<p>Often times cryo-EM users may want to process tens to hundreds of micrographs with 2DTM using the same search parameters, reference template, etc.
Using batch processing scripts to run through a large set of micrographs is extremely useful, especially when compared to running each 2DTM search manually.
In this tutorial, we walk through a basic example of doing batch processing with Leopard-EM on a cluster with SLURM scheduling.</p>
<p>The pre-requisites for this tutorial are:</p>
<ol>
<li>Multiple aligned and summed micrographs as MRC files.</li>
<li>A single simulated reference template in MRC format.</li>
<li>CTF estimations for each micrograph (tutorial assumes CTFFIND5 was used).</li>
<li>A cluster with SLURM scheduling and GPU nodes available.</li>
<li>Leopard-EM installed in the current Python environment.</li>
</ol>
<details class="note">
<summary>Why Leopard-EM doesn't handle batch processing internally</summary>
<p>Leopard-EM is designed to be a flexible and modular Python package for 2DTM, and as such we focus on providing the core functionality for 2DTM workflows.
Reproducibility is another key aspect of Leopard-EM, and we encourage users to have a one-to-one mapping between input configuration files and 2DTM results.
This means that Leopard-EM does not inherently handle batch processing, but instead provides a simple interface for users to write their own 2DTM workflows specific to their computing environments and project needs.</p>
</details>
<h2 id="pre-requisite-data-layout">Pre-requisite data layout</h2>
<p>This tutorial assumes you are working within a directory with already processed micrographs and associated CTF estimations as well as a simulated reference volume named <code>ref_template.mrc</code>.
Each micrograph has a unique name, and these micrographs are stored under the <code>micrographs/</code> directory.
The CTF estimations share the same prefix as the micrograph names, and are stored under the <code>ctf_estimations/</code> directory.
Below is an example of the directory structure where we have 100 micrographs:</p>
<div class="highlight"><pre><span></span><code>/some/path/to/my_project/
├── ref_template.mrc
├── micrographs/
│   ├── micrograph_0.mrc
│   ├── micrograph_1.mrc
│   ├── micrograph_2.mrc
│   ├── ...
│   ├── micrograph_99.mrc
├── ctf_estimations/
│   ├── micrograph_0_diagnostic.txt
│   ├── micrograph_1_diagnostic.txt
│   ├── micrograph_2_diagnostic.txt
│   ├── ...
│   ├── micrograph_99_diagnostic.txt
</code></pre></div>
<p>An example of the CTF estimation diagnostic file is shown below:</p>
<div class="highlight"><pre><span></span><code># Output from CTFFind version 5.0.2, run on 2025-02-13 21:14:21
# Input file: /some/path/to/my_project/micrograph_1.mrc ; Number of micrographs: 1
# Pixel size: 0.930 Angstroms ; acceleration voltage: 300.0 keV ; spherical aberration: 2.70 mm ; amplitude contrast: 0.07
# Box size: 512 pixels ; min. res.: 30.0 Angstroms ; max. res.: 3.5 Angstroms ; min. def.: 0.0 um; max. def. 50000.0 um
# Columns: #1 - micrograph number; #2 - defocus 1 [Angstroms]; #3 - defocus 2; #4 - azimuth of astigmatism; #5 - additional phase shift [radians]; #6 - cross correlation; #7 - spacing (in Angstroms) up to which CTF rings were fit successfully; #8 - Estimated tilt axis angle; #9 - Estimated tilt angle ; #10 Estimated sample thickness (in Angstroms)
1.000000 8984.742188 8709.236328 45.948771 0.000000 0.446317 3.720000 221.912292 12.251187 1619.773438
</code></pre></div>
<p>We will later write a Python function which reads in this diagnostic data and extracts the relevant defocus parameters for each micrograph.</p>
<h2 id="base-yaml-configuration-file">Base YAML configuration file</h2>
<p>Next, we need to create a base YAML configuration file.
Most of these fields will be the same for each micrograph, but other like the CTF defocus parameters need populated for each micrograph.
See the <a href="../../programs/match_template/">Match Template program page</a> for information on each of the configuration fields which will be specific to your cryo-EM imaging setup.
We enclose the populated fields in double curly braces <code>{{...}}</code> which are used for string replacement in the later Python script.</p>
<p>This file should be saved as <code>base_match_template_config.yaml</code> in the project directory root.</p>
<div class="admonition note">
<p class="admonition-title">Code copy button (top-left)</p>
<p>This tutorial includes <em>a lot</em> of code snippets.
There is a copy button in the top-left corner of each code block which will copy the entire code block to your clipboard.</p>
</div>
<div class="highlight"><pre><span></span><code><span class="c1"># base_match_template_config.yaml</span>
<span class="nt">template_volume_path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/some/path/to/my_project/ref_template.mrc&quot;</span>
<span class="nt">micrograph_path</span><span class="p">:</span><span class="w">      </span><span class="s">&quot;/some/path/to/my_project/micrographs/{{</span><span class="nv"> </span><span class="s">micrograph_path</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="nt">match_template_result</span><span class="p">:</span>
<span class="w">  </span><span class="nt">allow_file_overwrite</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">mip_path</span><span class="p">:</span><span class="w">                   </span><span class="s">&quot;/some/path/to/my_project/match_template_results/{{</span><span class="nv"> </span><span class="s">micrograph_name</span><span class="nv"> </span><span class="s">}}_output_mip.mrc&quot;</span>
<span class="w">  </span><span class="nt">scaled_mip_path</span><span class="p">:</span><span class="w">            </span><span class="s">&quot;/some/path/to/my_project/match_template_results/{{</span><span class="nv"> </span><span class="s">micrograph_name</span><span class="nv"> </span><span class="s">}}_output_scaled_mip.mrc&quot;</span>
<span class="w">  </span><span class="nt">orientation_psi_path</span><span class="p">:</span><span class="w">       </span><span class="s">&quot;/some/path/to/my_project/match_template_results/{{</span><span class="nv"> </span><span class="s">micrograph_name</span><span class="nv"> </span><span class="s">}}_output_orientation_psi.mrc&quot;</span>
<span class="w">  </span><span class="nt">orientation_theta_path</span><span class="p">:</span><span class="w">     </span><span class="s">&quot;/some/path/to/my_project/match_template_results/{{</span><span class="nv"> </span><span class="s">micrograph_name</span><span class="nv"> </span><span class="s">}}_output_orientation_theta.mrc&quot;</span>
<span class="w">  </span><span class="nt">orientation_phi_path</span><span class="p">:</span><span class="w">       </span><span class="s">&quot;/some/path/to/my_project/match_template_results/{{</span><span class="nv"> </span><span class="s">micrograph_name</span><span class="nv"> </span><span class="s">}}_output_orientation_phi.mrc&quot;</span>
<span class="w">  </span><span class="nt">relative_defocus_path</span><span class="p">:</span><span class="w">      </span><span class="s">&quot;/some/path/to/my_project/match_template_results/{{</span><span class="nv"> </span><span class="s">micrograph_name</span><span class="nv"> </span><span class="s">}}_output_relative_defocus.mrc&quot;</span>
<span class="w">  </span><span class="nt">correlation_average_path</span><span class="p">:</span><span class="w">   </span><span class="s">&quot;/some/path/to/my_project/match_template_results/{{</span><span class="nv"> </span><span class="s">micrograph_name</span><span class="nv"> </span><span class="s">}}_output_correlation_average.mrc&quot;</span>
<span class="w">  </span><span class="nt">correlation_variance_path</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;/some/path/to/my_project/match_template_results/{{</span><span class="nv"> </span><span class="s">micrograph_name</span><span class="nv"> </span><span class="s">}}_output_correlation_variance.mrc&quot;</span>
<span class="nt">optics_group</span><span class="p">:</span>
<span class="w">  </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my_optics_group</span>
<span class="w">  </span><span class="nt">voltage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300.0</span>
<span class="w">  </span><span class="nt">pixel_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.936</span><span class="w">   </span><span class="c1"># in Angstroms</span>
<span class="w">  </span><span class="nt">defocus_u</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">defocus_u_value</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w">  </span><span class="c1"># in Angstroms</span>
<span class="w">  </span><span class="nt">defocus_v</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">defocus_v_value</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w">  </span><span class="c1"># in Angstroms</span>
<span class="w">  </span><span class="nt">astigmatism_angle</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">astigmatism_angle_value</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">  </span><span class="nt">spherical_aberration</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.7</span><span class="w">  </span><span class="c1"># in millimeters</span>
<span class="w">  </span><span class="nt">amplitude_contrast_ratio</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.07</span>
<span class="w">  </span><span class="nt">phase_shift</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
<span class="w">  </span><span class="nt">ctf_B_factor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
<span class="nt">defocus_search_config</span><span class="p">:</span>
<span class="w">  </span><span class="nt">defocus_min</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-1000.0</span><span class="w">  </span><span class="c1"># in Angstroms, relative to defocus_{u,v}</span>
<span class="w">  </span><span class="nt">defocus_max</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000.0</span><span class="w">   </span><span class="c1"># in Angstroms, relative to defocus_{u,v}</span>
<span class="w">  </span><span class="nt">defocus_step</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200.0</span><span class="w">   </span><span class="c1"># in Angstroms</span>
<span class="nt">orientation_search_config</span><span class="p">:</span>
<span class="w">  </span><span class="nt">base_grid_method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">uniform</span>
<span class="w">  </span><span class="nt">psi_step</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.5</span><span class="w">    </span><span class="c1"># in degrees</span>
<span class="w">  </span><span class="nt">theta_step</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.5</span><span class="w">  </span><span class="c1"># in degrees</span>
<span class="nt">preprocessing_filters</span><span class="p">:</span>
<span class="w">  </span><span class="nt">whitening_filter</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">do_power_spectrum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">max_freq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span><span class="w">  </span><span class="c1"># In terms of Nyquist frequency</span>
<span class="w">    </span><span class="nt">num_freq_bins</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="w">  </span><span class="nt">bandpass_filter</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="nt">computational_config</span><span class="p">:</span>
<span class="w">  </span><span class="nt">gpu_ids</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;all&quot;</span>
<span class="w">  </span><span class="nt">num_cpus</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
</code></pre></div>
<h2 id="populating-the-yaml-configuration-file">Populating the YAML configuration file</h2>
<p>Now that we have a YAML configuration file to build off of, we next write a Python script to populate the necessary fields for each micrograph.
This script is basic expecting an exact correspondence between the micrograph names and the CTF estimation diagnostic files and that the diagnostics are from CTFFIND5.
However, this script is easily extensible to handle more complex cases.</p>
<p>After creating a new file with the following code and saving it as <code>populate_match_template_config.py</code>, our project directory structure should look like this:</p>
<div class="highlight"><pre><span></span><code>/some/path/to/my_project/
├── ref_template.mrc
├── micrographs/
│   ├── micrograph_0.mrc
│   ├── micrograph_1.mrc
│   ├── micrograph_2.mrc
│   ├── ...
│   ├── micrograph_99.mrc
├── ctf_estimations/
│   ├── micrograph_0_diagnostic.txt
│   ├── micrograph_1_diagnostic.txt
│   ├── micrograph_2_diagnostic.txt
│   ├── ...
│   ├── micrograph_99_diagnostic.txt
│
├── base_match_template_config.yaml    &lt;-- New (contents above)
└── populate_match_template_config.py  &lt;-- New (contents below)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Script to populate the base YAML configuration file for each micrograph.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>


<span class="c1"># Path constants which are updatable</span>
<span class="n">INPUT_MICROGRAPHS_DIR</span> <span class="o">=</span> <span class="s2">&quot;/some/path/to/my_project/micrographs/&quot;</span>
<span class="n">CTF_DIAGNOSTICS_DIR</span> <span class="o">=</span> <span class="s2">&quot;/some/path/to/my_project/ctf_estimations/&quot;</span>
<span class="n">BASE_CONFIG_PATH</span> <span class="o">=</span> <span class="s2">&quot;/some/path/to/my_project/base_match_template_config.yaml&quot;</span>
<span class="n">OUTPUT_DIR</span> <span class="o">=</span> <span class="s2">&quot;/some/path/to/my_project/match_template_results/&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_ctffind5_result</span><span class="p">(</span><span class="n">diagnostic_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse the CTFFIND5 diagnostic file to extract defocus parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    diagnostic_path : str</span>
<span class="sd">        Path to the CTFFIND5 diagnostic file.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[float, float, float]</span>
<span class="sd">        A tuple containing defocus values</span>
<span class="sd">        (defocus_u, defocus_v, astigmatism_angle).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">diagnostic_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="c1"># Assuming first non-comment line contains all info</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">):</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">defocus_u</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">defocus_v</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">astigmatism_angle</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">defocus_u</span><span class="p">,</span> <span class="n">defocus_v</span><span class="p">,</span> <span class="n">astigmatism_angle</span>


<span class="k">def</span><span class="w"> </span><span class="nf">populate_single_config</span><span class="p">(</span>
    <span class="n">base_config_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">micrograph_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ctf_diagnostic_path</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Populates a single configuration dictionary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    base_config_dict : dict</span>
<span class="sd">        The base configuration dictionary to populate.</span>
<span class="sd">    micrograph_path : str</span>
<span class="sd">        The path to the micrograph file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        The populated configuration dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Populate the micrograph path and results fields</span>
    <span class="n">base_config_dict</span><span class="p">[</span><span class="s2">&quot;micrograph_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">micrograph_path</span>

    <span class="c1"># Replace all &quot;{{ micrograph_name }}&quot; placeholders in match_template_result paths</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">micrograph_path</span><span class="p">)</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">result_key</span><span class="p">,</span> <span class="n">result_path</span> <span class="ow">in</span> <span class="n">base_config_dict</span><span class="p">[</span><span class="s2">&quot;match_template_result&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;{{ micrograph_name }}&quot;</span> <span class="ow">in</span> <span class="n">result_path</span><span class="p">:</span>
            <span class="n">updated_path</span> <span class="o">=</span> <span class="n">result_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{{ micrograph_name }}&quot;</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span>
            <span class="n">base_config_dict</span><span class="p">[</span><span class="s2">&quot;match_template_result&quot;</span><span class="p">][</span><span class="n">result_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_path</span>

    <span class="c1"># Get the defocus parameters and populate the optics group</span>
    <span class="n">defocus_u</span><span class="p">,</span> <span class="n">defocus_v</span><span class="p">,</span> <span class="n">astigmatism_angle</span> <span class="o">=</span> <span class="n">parse_ctffind5_result</span><span class="p">(</span><span class="n">ctf_diagnostic_path</span><span class="p">)</span>
    <span class="n">base_config_dict</span><span class="p">[</span><span class="s2">&quot;optics_group&quot;</span><span class="p">][</span><span class="s2">&quot;defocus_u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">defocus_u</span>
    <span class="n">base_config_dict</span><span class="p">[</span><span class="s2">&quot;optics_group&quot;</span><span class="p">][</span><span class="s2">&quot;defocus_v&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">defocus_v</span>
    <span class="n">base_config_dict</span><span class="p">[</span><span class="s2">&quot;optics_group&quot;</span><span class="p">][</span><span class="s2">&quot;astigmatism_angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">astigmatism_angle</span>

    <span class="k">return</span> <span class="n">base_config_dict</span>


<span class="k">def</span><span class="w"> </span><span class="nf">create_micrograph_pairs</span><span class="p">(</span><span class="n">micrograph_paths</span><span class="p">,</span> <span class="n">ctf_diagnostic_paths</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create pairs of micrograph and CTF diagnostic files.&quot;&quot;&quot;</span>
    <span class="c1"># Create dictionaries mapping index to file path</span>
    <span class="n">micrographs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">diagnostics</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Extract indices from micrograph files</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">micrograph_paths</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;micrograph_(\d+)\.mrc$&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">micrographs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>

    <span class="c1"># Extract indices from diagnostic files</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">ctf_diagnostic_paths</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;micrograph_(\d+)_diagnostic\.txt$&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">diagnostics</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>

    <span class="c1"># Create pairs for matching indices</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">micrographs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">diagnostics</span><span class="p">:</span>
            <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">micrographs</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">diagnostics</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">pairs</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main function to loop through all micrographs.&quot;&quot;&quot;</span>
    <span class="c1"># Find all micrographs and CTF diagnostics</span>
    <span class="n">micrograph_paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">INPUT_MICROGRAPHS_DIR</span><span class="p">,</span> <span class="s2">&quot;*.mrc&quot;</span><span class="p">))</span>
    <span class="n">ctf_diagnostic_paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CTF_DIAGNOSTICS_DIR</span><span class="p">,</span> <span class="s2">&quot;*_diagnostic.txt&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Create pairs based on filename indices</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="n">create_micrograph_pairs</span><span class="p">(</span><span class="n">micrograph_paths</span><span class="p">,</span> <span class="n">ctf_diagnostic_paths</span><span class="p">)</span>

    <span class="c1"># Load base configuration</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">BASE_CONFIG_PATH</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">base_config_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># Process each pair</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">micrograph_path</span><span class="p">,</span> <span class="n">ctf_diagnostic_path</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
        <span class="n">populated_config</span> <span class="o">=</span> <span class="n">populate_single_config</span><span class="p">(</span>
            <span class="n">base_config_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">micrograph_path</span><span class="p">,</span> <span class="n">ctf_diagnostic_path</span>
        <span class="p">)</span>

        <span class="c1"># Create output directory and save configuration</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">OUTPUT_DIR</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">micrograph_path</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.mrc&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_match_template_config.yaml&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_f</span><span class="p">:</span>
            <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">populated_config</span><span class="p">,</span> <span class="n">out_f</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished processing </span><span class="si">{</span><span class="n">output_filename</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<p>Now run the above script which will generate all the necessary YAML configurations.</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>populate_match_template_config.py
</code></pre></div>
<p>Our project directory structure should now look like this:</p>
<div class="highlight"><pre><span></span><code>/some/path/to/my_project/
├── ref_template.mrc
├── micrographs/
│   ├── micrograph_0.mrc
│   ├── micrograph_1.mrc
│   ├── micrograph_2.mrc
│   ├── ...
│   ├── micrograph_99.mrc
├── ctf_estimations/
│   ├── micrograph_0_diagnostic.txt
│   ├── micrograph_1_diagnostic.txt
│   ├── micrograph_2_diagnostic.txt
│   ├── ...
│   ├── micrograph_99_diagnostic.txt
├── match_template_results/                       &lt;-- New
│   ├── micrograph_0_match_template_config.yaml   &lt;-- New
│   ├── micrograph_1_match_template_config.yaml   &lt;-- New
│   ├── micrograph_2_match_template_config.yaml   &lt;-- New
│   ├── ...
│   ├── micrograph_99_match_template_config.yaml  &lt;-- New
├── base_match_template_config.yaml
└── populate_match_template_config.py
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Batch processing in Leopard-EM not depend on CTFFIND5</p>
<p>This tutorial assumes outputs from the CTFFIND5 program each in their own diagnostic file, but the above script can be adapted to any number of CTF estimation outputs.
As long as you can uniquely map each micrograph to a set of defocus parameters (presumably in a Python function), the above population of the configuration will be straightforward.</p>
</div>
<h2 id="setting-up-the-leopard-em-2dtm-script">Setting up the Leopard-EM 2DTM script</h2>
<p>The final step before job submission is to create a Python script for running the <code>match_template</code> program.
We adapt the included Python script from the <code>programs/</code> directory to accept a YAML file as an argument; the program is completely configured through the YAML file, so this is the only argument which changes between different 2DTM runs.
Copy the following code into a new file named <code>run_match_template.py</code> in the project directory root.</p>
<div class="highlight"><pre><span></span><code><span class="sd">&quot;&quot;&quot;Program for running whole-orientation search using 2D template matching.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">leopard_em.pydantic_models.managers</span><span class="w"> </span><span class="kn">import</span> <span class="n">MatchTemplateManager</span>

<span class="c1"># Change batch size based on available GPU memory</span>
<span class="n">ORIENTATION_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">8</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">yaml_config_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dataframe_output_path</span> <span class="o">=</span> <span class="n">yaml_config_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;results.csv&quot;</span><span class="p">)</span>
    <span class="n">mt_manager</span> <span class="o">=</span> <span class="n">MatchTemplateManager</span><span class="o">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="n">yaml_config_path</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loaded configuration.</span><span class="se">\n</span><span class="s2">Running match_template...&quot;</span><span class="p">)</span>

    <span class="n">mt_manager</span><span class="o">.</span><span class="n">run_match_template</span><span class="p">(</span>
        <span class="n">orientation_batch_size</span><span class="o">=</span><span class="n">ORIENTATION_BATCH_SIZE</span><span class="p">,</span>
        <span class="n">do_result_export</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Saves the statistics immediately upon completion</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished core match_template call.</span><span class="se">\n</span><span class="s2">Exporting results...&quot;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">mt_manager</span><span class="o">.</span><span class="n">results_to_dataframe</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">dataframe_output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>


<span class="c1"># NOTE: Invoking  program under `if __name__ == &quot;__main__&quot;`</span>
<span class="c1"># necessary for multiprocesing</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<p>Thats it!
From the project directory root, we can now initiate a 2DTM run through the following
command for a particular configuration:</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>run_match_template.py<span class="w"> </span>match_template_results/micrograph_0_match_template_config.yaml
</code></pre></div>
<h2 id="wrapping-the-runs-into-a-slurm-array-job">Wrapping the runs into a SLURM array job</h2>
<p>Rather than running each 2DTM search manually, we can use an included SLURM job scheduler to process all of the data. Here, we choose to use a SLURM array job since we have a large number of micrographs to process and the computational needs don't change between runs.</p>
<div class="admonition caution">
<p class="admonition-title">Adapting to your SLURM environment</p>
<p>Different computing environments have different SLURM configurations including how to request GPU resources, constraints on job allocations, and how to record allocations to a computing account.
We cannot possibly enumerate all possible configurations, but the following script is a good starting point.
You will need to adapt the SLURM job script below to your specific computing environment, but the principles of running <em>N</em> independent searches across <em>N</em> micrographs remains the same.</p>
</div>
<p>Create a new file named <code>run_match_template_slurm.sh</code> in the project directory root with the following code:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1">#SBATCH --job-name=batch_2dtm_example</span>
<span class="c1">#SBATCH --account=&lt;&lt;&lt;YOUR_ACCOUNT&gt;&gt;&gt;</span>
<span class="c1">#SBATCH --partition=&lt;&lt;&lt;YOUR_PARTITION&gt;&gt;&gt;</span>
<span class="c1">#SBATCH --qos=&lt;&lt;&lt;YOUR_QOS&gt;&gt;&gt;</span>
<span class="c1">#SBATCH --ntasks=1</span>
<span class="c1">#SBATCH --cpus-per-task=8  # &lt;------ Match with &#39;num_cpus&#39; in YAML</span>
<span class="c1">#SBATCH --gres=gpu:L40:1  # &lt;------- Adjust based on GPU/node configuration</span>
<span class="c1">#SBATCH --time=10:00:00</span>
<span class="c1">#SBATCH --array=0-99  # &lt;----------- Adjust based on number of micrographs</span>
<span class="c1">#SBATCH --output=batch_2dtm_example_%A_task_%a.out</span>
<span class="c1">#SBATCH --error=batch_2dtm_example_%A_task_%a.err</span>

<span class="c1">#####################################</span>
<span class="c1">### Load modules and activate     ###</span>
<span class="c1">### Leopard-EM Python environment ###</span>
<span class="c1">#####################################</span>
<span class="c1"># NOTE: You will need to adjust these lines!</span>
ml<span class="w"> </span>anaconda3
conda<span class="w"> </span>activate<span class="w"> </span>leopard-em

<span class="c1">#######################################################</span>
<span class="c1">### Decode config file based on SLURM_ARRAY_TASK_ID ###</span>
<span class="c1">#######################################################</span>
<span class="c1"># NOTE: You will also need to adjust the CONFIG_DIRECTORY variable below</span>
<span class="nv">CONFIG_DIRECTORY</span><span class="o">=</span><span class="s2">&quot;/some/path/to/my_project/match_template_results&quot;</span>

<span class="c1"># Find all YAML files in the directory, sort them, and select the one corresponding to the current task ID.</span>
<span class="c1"># NOTE: Does not depend on naming scheme and should work for any set of YAML configurations.</span>
<span class="nv">CONFIG_FILE</span><span class="o">=</span><span class="k">$(</span>ls<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CONFIG_DIRECTORY</span><span class="si">}</span><span class="s2">&quot;</span>/*.yaml<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="k">$((</span><span class="nv">SLURM_ARRAY_TASK_ID</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="k">))</span><span class="s2">p&quot;</span><span class="k">)</span>

<span class="c1"># Check if the config file exists</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CONFIG_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Error: No config file found for task ID </span><span class="nv">$SLURM_ARRAY_TASK_ID</span><span class="s2">.&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="c1"># Run the match_template script with the selected config file</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Running match_template with config file: </span><span class="nv">$CONFIG_FILE</span><span class="s2">&quot;</span>
python<span class="w"> </span>run_match_template.py<span class="w"> </span><span class="nv">$CONFIG_FILE</span>
</code></pre></div>
<h2 id="conclusion">Conclusion</h2>
<p>In this tutorial, we walked through how to set up batch processing of micrographs with Leopard-EM using a SLURM array job.
Many components of this tutorial will need to be adapted to your specific use-case, like the naming convention for micrographs, how the CTF estimations are mapped to each micrograph, and your particular SLURM environment.
However, the principles of creating a single YAML configuration for each template matching run and then executing each run independently remain the same.</p>
<p>In short, batch processing with Leopard-EM follows these steps:
1. Placing micrographs and CTF estimations in a known directory structure,
2. Creating a base YAML configuration file with placeholders for micrograph-specific parameters,
3. Populating the YAML configuration file for each micrograph, and
4. Running the <code>match_template</code> program for each of the populated YAML configuration files.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>